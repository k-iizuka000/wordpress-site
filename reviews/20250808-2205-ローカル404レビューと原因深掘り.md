# レビュー: ローカル404（製作実績ほか）修正内容の確認と原因深掘り

## サマリー
- テーマ側で `after_switch_theme` によるページ作成とリライトルールのフラッシュ（フラグ方式）を実装済み。
- しかし「既に有効化済みのテーマ」にコードを後入れした場合、`after_switch_theme` は発火せず、ページ作成やフラッシュが未実行のまま残るリスクがある。
- その結果、以下が依然として404を誘発しうる:
  - 固定ページ（/about, /skills, /contact, /portfolio）が未作成
  - CPTアーカイブ `/projects/` のルール未フラッシュ
  - `.htaccess` 未反映（ただしDockerのVirtualHost設定でRewrite済みのため優先度は低）

## 実装レビュー
- テーマ: `themes/kei-portfolio/inc/setup.php`
  - `after_switch_theme` でフラグを立て、`init(999)` で `flush_rewrite_rules()` を1回だけ実行 → ベストプラクティスに沿っていて良い。
  - 注意点: 既にテーマが有効な状態では `after_switch_theme` が動かないため、フラグが立たない。
- テーマ: `themes/kei-portfolio/inc/page-creator.php`
  - `add_action('after_switch_theme', 'kei_portfolio_create_pages_on_activation')` により固定ページ生成。
  - 同様に「後入れ」だと未実行のまま。
- メニュー/リンク:
  - ヘッダーの「制作実績」は `get_post_type_archive_link('project')` を参照。CPT登録とRewriteが正しくフラッシュされていれば `/projects/` が有効。
- `.htaccess`
  - `themes/kei-portfolio-upload/.htaccess-for-root` はWP標準ルールを含む。運用でルートへコピーすればOK。

## 追加で疑うべきポイント（深掘り）
1) テーマ有効化イベント未発火
- テーマを一度別テーマへ切替→再度 `kei-portfolio` に戻すか、WP-CLIで有効化し直すと `after_switch_theme` が確実に発火。

2) パーマリンク設定未保存（未フラッシュ）
- 管理画面→設定→パーマリンク→「変更を保存」をクリックでFlush（変更不要でも保存だけでOK）。

3) コンテンツ未作成
- 固定ページ（about/skills/contact/portfolio）やProjects投稿がゼロ。

4) DBのsiteurl/home不整合
- `siteurl`/`home`が本番ドメインのままだと意図しない遷移→404。

## ローカル現地確認コマンド（WP-CLI）
以下をDocker内（WordPressコンテナ）で実行してください。

```bash
# 1) 有効テーマ確認
wp theme list --status=active

# 2) パーマリンク構造とRewriteルール
wp option get permalink_structure
wp rewrite list | grep -E 'project|projects' || true
wp rewrite flush --hard

# 3) 固定ページとProjectsの存在確認
wp post list --post_type=page --fields=ID,post_title,post_name,post_status | grep -E 'about|skills|contact|portfolio' || true
wp post list --post_type=project --post_status=publish --fields=ID,post_title,post_name || true

# 4) URL整合
wp option get siteurl
wp option get home
```

想定結果/判定:
- permalink_structure が `/%postname%/` 等である
- `wp rewrite list` に `^projects/?` 等のルールが存在
- 固定ページ `about/skills/contact/portfolio` が `publish`
- `siteurl`/`home` が `http://localhost:8090`

## 具体的な復旧手順（最短）
- 手順A: テーマの再有効化（after_switch_theme発火）
  ```bash
  wp theme activate twentytwentyfour
  wp theme activate kei-portfolio
  wp rewrite flush --hard
  ```
- 手順B: 固定ページ作成（自動が効かなかった場合）
  ```bash
  wp post create --post_type=page --post_status=publish --post_title=About --post_name=about
  wp post create --post_type=page --post_status=publish --post_title=Skills --post_name=skills
  wp post create --post_type=page --post_status=publish --post_title=Contact --post_name=contact
  wp post create --post_type=page --post_status=publish --post_title=Portfolio --post_name=portfolio
  ```
- 手順C: Projects初期データ（0件なら1件投入）
  ```bash
  wp post list --post_type=project --post_status=publish --format=count | grep -q 0 && \
  wp post create --post_type=project --post_status=publish --post_title='Sample Project' --post_content='Auto seeded sample.'
  ```
- 手順D: URL整合
  ```bash
  wp option update siteurl 'http://localhost:8090'
  wp option update home 'http://localhost:8090'
  ```

## 追加の技術的提案（任意）
- 管理画面から手動実行できる「ページ作成/Rewriteフラッシュ」管理メニューの追加（admin_action + nonce）。
- 初回アクセス時のみ `kei_portfolio_pages_created`/`kei_portfolio_flush_rewrite` を確認→必要なら通知/ボタン表示。
- 診断シェルを用意（`docker exec`でWP-CLI一括実行）。

## 結論
- 実装は正しく、再発防止としても妥当。ただし「テーマを既に有効化済みの環境にコードを適用したケース」で `after_switch_theme` が動作していない可能性が高い。
- 上記の現地確認と復旧手順A〜Dを順に実施すれば、`/projects/` と固定ページ配下の404は解消見込み。

作成: 2025-08-08 22:05
