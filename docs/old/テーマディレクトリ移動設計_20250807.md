# テーマディレクトリ移動設計書

## 設計日時
2025年8月7日

## 目的
WordPressテーマディレクトリを `/wordpress/wp-content/themes/kei-portfolio` から `/themes/kei-portfolio` に安全に移動するための詳細設計と実装手順を定義する。

## 前提条件
- Git でバージョン管理されていること
- Docker環境が構築済みであること
- 現在のテーマが正常に動作していること
- バックアップが取得可能であること

## 移動後の構造
```
/Users/kei/work/wordpress-site/
├── themes/
│   └── kei-portfolio/      # 新しいテーマ位置
├── wordpress/
│   └── wp-content/
│       └── themes/          # 空になる（他のテーマがなければ）
├── docker-compose.yml       # 要修正
├── Dockerfile              # 要修正
└── wp-config.docker.php    # 確認要
```

## 実装手順

### Phase 1: 準備作業（所要時間: 30分）

#### 1.1 現状確認とバックアップ
```bash
# 現在のブランチを確認
git status
git branch

# 新しいブランチを作成
git checkout -b feature/move-theme-directory

# 現在の状態をコミット
git add .
git commit -m "chore: テーマディレクトリ移動前の状態を保存"

# データベースのバックアップ（Docker環境の場合）
docker exec kei-portfolio-db mysqldump -u wp_user -pwp_password kei_portfolio_dev > backup_$(date +%Y%m%d_%H%M%S).sql
```

#### 1.2 Docker環境の停止
```bash
# コンテナを停止
docker-compose down

# ボリュームの確認（データが永続化されているか）
docker volume ls
```

### Phase 2: ディレクトリ移動（所要時間: 15分）

#### 2.1 テーマディレクトリの移動
```bash
# プロジェクトルートで実行
mkdir -p themes
mv wordpress/wp-content/themes/kei-portfolio themes/

# 移動確認
ls -la themes/kei-portfolio/
```

#### 2.2 シンボリックリンクの作成（オプション）
WordPressが期待する位置にシンボリックリンクを作成することで、互換性を保つ：
```bash
cd wordpress/wp-content/themes/
ln -s ../../../themes/kei-portfolio kei-portfolio
cd ../../../
```

### Phase 3: 設定ファイルの修正（所要時間: 45分）

#### 3.1 docker-compose.yml の修正
```yaml
# 修正前（20行目付近）
volumes:
  - ./wordpress/wp-content/themes/kei-portfolio:/var/www/html/wp-content/themes/kei-portfolio:cached

# 修正後
volumes:
  - ./themes/kei-portfolio:/var/www/html/wp-content/themes/kei-portfolio:cached
```

#### 3.2 Dockerfile の修正
```dockerfile
# 修正前（88行目付近）
COPY wordpress/wp-content/themes/kei-portfolio/ ./wp-content/themes/kei-portfolio/

# 修正後
COPY themes/kei-portfolio/ ./wp-content/themes/kei-portfolio/
```

#### 3.3 Dockerfile.optimized の修正
```dockerfile
# 同様の修正を適用
# COPYコマンドのパスを更新
```

#### 3.4 docker-compose.*.yml ファイルの修正
以下のファイルも同様に修正：
- `docker-compose.optimized.yml`
- `docker-compose.simple.yml`
- `docker-compose.test.yml`

#### 3.5 テストファイルの修正

**tests/bootstrap.php の修正（67行目）**
```php
// 修正前
define( 'ABSPATH', dirname( dirname( dirname( dirname( __DIR__ ) ) ) ) . '/' );

// 修正後（階層が2つ減る）
define( 'ABSPATH', dirname( dirname( __DIR__ ) ) . '/' );
```

### Phase 4: 環境の再構築（所要時間: 30分）

#### 4.1 Dockerイメージの再ビルド
```bash
# キャッシュをクリアして完全に再ビルド
docker-compose build --no-cache

# または最適化版を使用している場合
docker-compose -f docker-compose.optimized.yml build --no-cache
```

#### 4.2 コンテナの起動
```bash
# コンテナを起動
docker-compose up -d

# ログを確認
docker-compose logs -f wordpress
```

#### 4.3 テーマの有効化確認
```bash
# WP-CLIを使用してテーマ状態を確認
docker exec kei-portfolio-dev wp theme list

# 必要に応じてテーマを再有効化
docker exec kei-portfolio-dev wp theme activate kei-portfolio
```

### Phase 5: 動作確認とテスト（所要時間: 60分）

#### 5.1 基本動作確認
- [ ] サイトのトップページが表示される
- [ ] 管理画面にログインできる
- [ ] テーマが有効になっている
- [ ] カスタマイザーが動作する
- [ ] メディアアップロードが動作する

#### 5.2 テーマ機能確認
- [ ] 各ページテンプレートが正常に表示される
  - [ ] フロントページ
  - [ ] About ページ
  - [ ] Portfolio ページ
  - [ ] Skills ページ
  - [ ] Contact ページ
- [ ] カスタム投稿タイプ（Projects）が動作する
- [ ] AJAX機能（お問い合わせフォーム）が動作する
- [ ] アセット（CSS/JS）が正しく読み込まれる

#### 5.3 自動テストの実行
```bash
# PHPユニットテスト
cd themes/kei-portfolio
composer test

# JavaScriptテスト
npm test

# 全テストスイート実行
composer check:full
npm run ci
```

#### 5.4 カバレッジファイルの再生成
```bash
# カバレッジファイルをクリア
rm -rf themes/kei-portfolio/tests/coverage/*

# カバレッジを再生成
composer test:coverage
npm run test:coverage
```

### Phase 6: Git操作とデプロイ準備（所要時間: 30分）

#### 6.1 変更のコミット
```bash
# 変更を確認
git status
git diff

# .gitignore の更新（必要に応じて）
echo "# 旧テーマディレクトリ（移動済み）" >> .gitignore
echo "wordpress/wp-content/themes/kei-portfolio" >> .gitignore

# 変更をステージング
git add .

# コミット
git commit -m "refactor: テーマディレクトリを /themes/kei-portfolio に移動

- Docker設定ファイルのパスを更新
- テストファイルのパス参照を修正
- プロジェクト構造を簡潔化"
```

#### 6.2 プルリクエストの作成
```bash
# リモートにプッシュ
git push origin feature/move-theme-directory

# GitHubでプルリクエストを作成
```

## ロールバック手順

問題が発生した場合の復旧手順：

### 即座のロールバック
```bash
# 変更を破棄
git reset --hard HEAD~1

# テーマを元の位置に戻す
mv themes/kei-portfolio wordpress/wp-content/themes/

# Docker設定を元に戻す
git checkout -- docker-compose.yml Dockerfile

# コンテナを再起動
docker-compose down
docker-compose up -d
```

### データベースの復旧
```bash
# バックアップから復元
docker exec -i kei-portfolio-db mysql -u wp_user -pwp_password kei_portfolio_dev < backup_YYYYMMDD_HHMMSS.sql
```

## チェックリスト

### 移動前
- [ ] バックアップ取得完了
- [ ] 現在の動作確認完了
- [ ] 新しいブランチ作成
- [ ] チームへの通知

### 移動作業
- [ ] テーマディレクトリ移動
- [ ] docker-compose.yml 修正
- [ ] Dockerfile 修正
- [ ] その他Docker設定修正
- [ ] テストファイル修正

### 移動後
- [ ] Docker環境再構築
- [ ] 基本動作確認
- [ ] テーマ機能確認
- [ ] 自動テスト合格
- [ ] パフォーマンス確認

### 完了条件
- [ ] すべての機能が正常動作
- [ ] テストがすべて合格
- [ ] ドキュメント更新
- [ ] チームレビュー完了

## リスク管理

### 想定されるトラブルと対処法

#### 1. Dockerコンテナが起動しない
**原因**: パス設定の誤り
**対処**: docker-compose.yml のパスを再確認、ログを詳細に確認

#### 2. テーマが認識されない
**原因**: WordPressがテーマを見つけられない
**対処**: シンボリックリンクを作成、またはwp-config.phpでテーマディレクトリを指定

#### 3. アセットが読み込まれない
**原因**: URLパスの不整合
**対処**: ブラウザの開発者ツールで404エラーを確認、enqueue.phpを確認

#### 4. テストが失敗する
**原因**: パス定数の不整合
**対処**: bootstrap.phpのABSPATH定義を確認、テスト用定数を調整

## 移行後の保守

### ドキュメント更新
- README.md のディレクトリ構造説明
- 開発環境セットアップガイド
- デプロイ手順書

### チーム周知事項
- 新しいディレクトリ構造の説明
- 開発時の注意点
- トラブルシューティングガイド

## まとめ

この設計書に従って作業を進めることで、安全にテーマディレクトリを移動できます。ただし、影響調査レポートでも述べた通り、**標準構造を維持することを推奨**します。

移動を実施する場合は、十分な検証時間を確保し、段階的に進めることが重要です。