# WordPressテーマディレクトリ完全移行実装計画

## 作成日時
2025年8月7日

## エグゼクティブサマリー
WordPressテーマディレクトリを旧パス `/wordpress/wp-content/themes/kei-portfolio` から新パス `/themes/kei-portfolio` へ移行するための包括的な実装計画。作業は10グループに分割し、段階的かつリスクを最小化して実施する。

## 移行の概要

### 現状構造
```
/Users/kei/work/wordpress-site/
├── wordpress/
│   └── wp-content/
│       └── themes/
│           └── kei-portfolio/  # 現在位置（27ファイル + testsディレクトリ）
├── docker-compose.yml
├── Dockerfile
└── tests/
```

### 移行後構造
```
/Users/kei/work/wordpress-site/
├── themes/
│   └── kei-portfolio/          # 新位置
├── wordpress/
│   └── wp-content/
│       └── themes/              # 空になる
├── docker-compose.yml          # 要修正
├── Dockerfile                  # 要修正
└── tests/
```

## リスク評価と対策

### リスクマトリクス

| リスク項目 | 発生確率 | 影響度 | リスクレベル | 対策 |
|-----------|---------|--------|------------|------|
| Docker起動失敗 | 中 | 高 | 高 | 設定ファイル事前検証、段階的テスト |
| テスト環境破損 | 低 | 中 | 中 | bootstrap.php事前修正、カバレッジ再生成 |
| 本番環境影響 | 低 | 極高 | 高 | 開発環境で完全検証後に適用 |
| パス参照エラー | 中 | 中 | 中 | 全ファイル検索・置換、自動テスト実行 |
| Git履歴断絶 | 低 | 低 | 低 | mvコマンド使用で履歴保持 |
| ビルドプロセス失敗 | 低 | 中 | 低 | package.json相対パス確認済み |

### 失敗時の影響分析

#### 即座に復旧可能（5分以内）
- Docker設定ミス → git resetで復旧
- テストファイルエラー → バックアップから復元

#### 短時間で復旧可能（30分以内）
- データベース不整合 → バックアップから復元
- アセット読み込みエラー → パス修正で対応

#### 長時間を要する可能性（1時間以上）
- 本番環境への誤適用 → 完全ロールバック必要
- 複数システムの依存関係破損 → 段階的修復必要

## 作業グループ分割（全10グループ）

### グループ1: 事前準備とバックアップ
**優先度**: 必須  
**リスクレベル**: 低  
**予想作業時間**: 30分  
**依存関係**: なし（最初に実行）

#### 作業内容
1. 現在の動作状態を記録
2. データベースバックアップ取得
3. ファイルシステムバックアップ作成
4. 新規ブランチ作成

#### 対象ファイル
- なし（バックアップ作成のみ）

#### テスト項目
- [ ] バックアップファイルの存在確認
- [ ] バックアップサイズの妥当性確認
- [ ] データベースダンプの整合性確認

#### 実行コマンド
```bash
# 現状確認
docker-compose ps
docker exec kei-portfolio-dev wp theme list

# バックアップ作成
tar -czf backup_theme_$(date +%Y%m%d_%H%M%S).tar.gz wordpress/wp-content/themes/kei-portfolio
docker exec kei-portfolio-db mysqldump -u wp_user -pwp_password kei_portfolio_dev > backup_db_$(date +%Y%m%d_%H%M%S).sql

# ブランチ作成
git checkout -b feature/theme-directory-migration
git add .
git commit -m "chore: 移行前の状態を保存"
```

### グループ2: ファイル移動
**優先度**: 必須  
**リスクレベル**: 中  
**予想作業時間**: 15分  
**依存関係**: グループ1完了後

#### 作業内容
1. テーマディレクトリの物理的移動
2. Git履歴の保持確認
3. 権限設定の確認

#### 対象ファイル
- `/wordpress/wp-content/themes/kei-portfolio/` → `/themes/kei-portfolio/`

#### テスト項目
- [ ] ファイル数の一致確認（移動前後）
- [ ] ディレクトリ構造の保持確認
- [ ] ファイル権限の保持確認
- [ ] Git履歴の保持確認

#### 実行コマンド
```bash
# Docker停止
docker-compose down

# ディレクトリ作成と移動
mkdir -p themes
mv wordpress/wp-content/themes/kei-portfolio themes/

# 確認
ls -la themes/kei-portfolio/
find themes/kei-portfolio -type f | wc -l
git log --follow themes/kei-portfolio/functions.php
```

### グループ3: メインDocker設定修正
**優先度**: 必須  
**リスクレベル**: 高  
**予想作業時間**: 20分  
**依存関係**: グループ2完了後

#### 作業内容
1. docker-compose.yml修正
2. Dockerfile修正
3. 設定ファイルの構文チェック

#### 対象ファイル
- `docker-compose.yml` (line 20)
- `Dockerfile` (line 88, 121)

#### 修正内容
```yaml
# docker-compose.yml (line 20)
# 修正前
- ./wordpress/wp-content/themes/kei-portfolio:/var/www/html/wp-content/themes/kei-portfolio:cached

# 修正後
- ./themes/kei-portfolio:/var/www/html/wp-content/themes/kei-portfolio:cached
```

```dockerfile
# Dockerfile (line 88, 121)
# 修正前
COPY wordpress/wp-content/themes/kei-portfolio/ ./wp-content/themes/kei-portfolio/

# 修正後
COPY themes/kei-portfolio/ ./wp-content/themes/kei-portfolio/
```

#### テスト項目
- [ ] YAML構文チェック合格
- [ ] Dockerfile構文チェック合格
- [ ] docker-compose config実行成功

### グループ4: 追加Docker設定修正
**優先度**: 必須  
**リスクレベル**: 中  
**予想作業時間**: 30分  
**依存関係**: グループ3と並行可能

#### 作業内容
1. 他のDocker設定ファイル修正
2. バックアップファイルの更新確認

#### 対象ファイル
- `docker-compose.optimized.yml` (line 22)
- `docker-compose.simple.yml` (line 20)
- `docker-compose.yml.backup` (line 18, 122)
- `Dockerfile.backup` (line 64)
- `Dockerfile.optimized` (要確認)

#### テスト項目
- [ ] 各ファイルの構文チェック
- [ ] パス参照の一貫性確認

### グループ5: テスト環境設定修正
**優先度**: 必須  
**リスクレベル**: 中  
**予想作業時間**: 45分  
**依存関係**: グループ2完了後

#### 作業内容
1. テストbootstrap.php修正
2. カバレッジファイルのクリア
3. テスト設定ファイルの更新

#### 対象ファイル
- `/themes/kei-portfolio/tests/bootstrap.php` (line 67)
- `/themes/kei-portfolio/tests/coverage/` (削除して再生成)
- `/themes/kei-portfolio/phpunit.xml` (パス確認)

#### 修正内容
```php
// bootstrap.php (line 67)
// 修正前（wordpress/wp-content/themes/kei-portfolio/tests/からの相対パス）
define( 'ABSPATH', dirname( dirname( dirname( dirname( __DIR__ ) ) ) ) . '/' );

// 修正後（themes/kei-portfolio/tests/からの相対パス）
define( 'ABSPATH', dirname( dirname( __DIR__ ) ) . '/wordpress/' );
```

#### テスト項目
- [ ] PHPUnit実行成功
- [ ] Jest実行成功
- [ ] カバレッジ生成成功

### グループ6: Docker環境再構築
**優先度**: 必須  
**リスクレベル**: 高  
**予想作業時間**: 30分  
**依存関係**: グループ3,4,5完了後

#### 作業内容
1. Dockerイメージの再ビルド
2. コンテナ起動
3. 初期動作確認

#### 実行コマンド
```bash
# クリーンビルド
docker-compose build --no-cache

# コンテナ起動
docker-compose up -d

# ログ確認
docker-compose logs -f wordpress

# テーマ状態確認
docker exec kei-portfolio-dev wp theme list
```

#### テスト項目
- [ ] コンテナ全て正常起動
- [ ] WordPressアクセス可能
- [ ] テーマが認識される
- [ ] エラーログなし

### グループ7: ドキュメント・設定ファイル更新
**優先度**: 中  
**リスクレベル**: 低  
**予想作業時間**: 60分  
**依存関係**: グループ2完了後（並行作業可能）

#### 作業内容
1. READMEファイルの更新
2. ドキュメント内のパス参照更新
3. .gitignore更新

#### 対象ファイル（主要なもの）
- `README.md`
- `.gitignore`
- `docs/`配下の各種ドキュメント
- `tasks/`配下の作業指示書
- `reports/`配下のレポート
- `learning/学習記録.md`

#### 修正例
```markdown
# README.md
# 修正前
- ルートで表示するテーマ格納場所：@wordpress/wp-content/themes/kei-portfolio

# 修正後
- ルートで表示するテーマ格納場所：@themes/kei-portfolio
```

```gitignore
# .gitignore
# 追加
/wordpress/wp-content/themes/kei-portfolio  # 旧ディレクトリ（移動済み）

# 修正
# 修正前
!/wordpress/wp-content/themes/kei-portfolio/

# 修正後
# この行は削除
```

#### テスト項目
- [ ] 全ドキュメントのパス整合性
- [ ] .gitignoreの動作確認

### グループ8: 機能テスト実行
**優先度**: 必須  
**リスクレベル**: 低  
**予想作業時間**: 60分  
**依存関係**: グループ6完了後

#### 作業内容
1. 自動テスト実行
2. 手動テスト実行
3. パフォーマンステスト

#### テスト項目
##### 自動テスト
```bash
# PHPテスト
cd themes/kei-portfolio
composer test
composer test:coverage

# JavaScriptテスト
npm test
npm run test:coverage

# 統合テスト
composer check:full
npm run ci
```

##### 手動テスト
- [ ] トップページ表示
- [ ] 管理画面ログイン
- [ ] テーマカスタマイザー動作
- [ ] 各ページテンプレート表示
  - [ ] About
  - [ ] Portfolio
  - [ ] Skills
  - [ ] Contact
- [ ] カスタム投稿タイプ（Projects）
- [ ] お問い合わせフォーム（AJAX）
- [ ] メディアアップロード

##### パフォーマンステスト
- [ ] ページ読み込み速度
- [ ] アセット読み込み確認
- [ ] キャッシュ動作確認

### グループ9: 本番環境準備（オプション）
**優先度**: 任意  
**リスクレベル**: 高  
**予想作業時間**: 30分  
**依存関係**: グループ8完了後

#### 作業内容
1. 本番用Dockerfile確認
2. デプロイスクリプト更新
3. CI/CD設定更新

#### 対象ファイル
- `Dockerfile` (本番用設定)
- デプロイスクリプト（存在する場合）
- GitHub Actions設定（存在する場合）

#### テスト項目
- [ ] 本番ビルド成功
- [ ] デプロイテスト環境での動作確認

### グループ10: 最終確認とコミット
**優先度**: 必須  
**リスクレベル**: 低  
**予想作業時間**: 30分  
**依存関係**: 全グループ完了後

#### 作業内容
1. 全体動作確認
2. 変更内容の最終レビュー
3. Gitコミットとプッシュ

#### 実行コマンド
```bash
# 最終確認
git status
git diff --stat

# コミット
git add .
git commit -m "refactor: テーマディレクトリを /themes/kei-portfolio に移動

- Docker設定ファイルのパス更新
- テスト環境のパス修正
- ドキュメントの更新
- プロジェクト構造の簡潔化

Breaking Change: テーマの物理的な位置が変更されています"

# プッシュ
git push origin feature/theme-directory-migration
```

#### テスト項目
- [ ] 全機能の動作確認完了
- [ ] パフォーマンス劣化なし
- [ ] エラーログなし
- [ ] コミット成功

## 実装の優先順位と段階的アプローチ

### フェーズ1: 最小限の移行（必須）
- グループ1-6: 基本的な移動と動作確保
- 所要時間: 約3時間
- この段階で基本動作が確認できれば、一旦作業を中断可能

### フェーズ2: 完全性の確保（推奨）
- グループ7-8: ドキュメント更新とテスト
- 所要時間: 約2時間
- 品質保証のために推奨

### フェーズ3: 本番対応（任意）
- グループ9-10: 本番環境対応と最終化
- 所要時間: 約1時間
- 本番環境がある場合のみ必要

## ロールバック手順

### 即座のロールバック（作業中の任意の時点）
```bash
# Gitでの復旧
git reset --hard HEAD
git clean -fd

# 手動での復旧
mv themes/kei-portfolio wordpress/wp-content/themes/
git checkout -- docker-compose.yml Dockerfile

# Docker再起動
docker-compose down
docker-compose up -d
```

### データベース復旧（必要な場合）
```bash
# バックアップから復元
docker exec -i kei-portfolio-db mysql -u wp_user -pwp_password kei_portfolio_dev < backup_db_YYYYMMDD_HHMMSS.sql
```

## チェックリスト

### 作業開始前
- [ ] 現在のサイトが正常動作している
- [ ] バックアップが取得済み
- [ ] 作業時間が確保されている（最低3時間）
- [ ] チームへの通知完了

### 各グループ完了時
- [ ] グループ1: バックアップ完了
- [ ] グループ2: ファイル移動完了
- [ ] グループ3: メインDocker設定完了
- [ ] グループ4: 追加Docker設定完了
- [ ] グループ5: テスト設定完了
- [ ] グループ6: Docker再構築完了
- [ ] グループ7: ドキュメント更新完了
- [ ] グループ8: テスト合格
- [ ] グループ9: 本番準備完了（オプション）
- [ ] グループ10: 最終確認完了

### 完了条件
- [ ] 全ての機能が正常動作
- [ ] 全てのテストが合格
- [ ] パフォーマンス劣化なし
- [ ] ドキュメント整合性確保
- [ ] チームレビュー完了

## トラブルシューティングガイド

### 問題1: Dockerコンテナが起動しない
**症状**: docker-compose up でエラー
**原因**: パス設定の誤り
**対処**:
```bash
# 設定確認
docker-compose config

# パス存在確認
ls -la themes/kei-portfolio/

# 権限確認
ls -la themes/kei-portfolio/ | head
```

### 問題2: テーマが認識されない
**症状**: WordPressでテーマが表示されない
**原因**: ボリュームマウントの失敗
**対処**:
```bash
# コンテナ内確認
docker exec kei-portfolio-dev ls -la /var/www/html/wp-content/themes/

# シンボリックリンク作成（緊急対応）
docker exec kei-portfolio-dev ln -s /var/www/html/wp-content/themes/kei-portfolio /tmp/theme-link
```

### 問題3: テストが失敗する
**症状**: PHPUnitエラー
**原因**: パス定数の不整合
**対処**:
```bash
# bootstrap.php確認
cat themes/kei-portfolio/tests/bootstrap.php | grep ABSPATH

# 手動でパス調整
vim themes/kei-portfolio/tests/bootstrap.php
```

### 問題4: アセットが読み込まれない
**症状**: CSS/JSが404エラー
**原因**: URLパスの不整合
**対処**:
```bash
# ブラウザ開発者ツールで404確認
# themes/kei-portfolio/inc/enqueue.php確認
# get_template_directory_uri()の使用確認
```

## 推奨事項と注意点

### 推奨事項
1. **段階的実施**: フェーズ1完了後に一旦評価
2. **ペアワーク**: 可能であれば2人で作業
3. **時間帯選択**: トラフィックの少ない時間帯
4. **通知徹底**: 関係者への事前・事後通知

### 注意点
1. **標準構造からの逸脱**: WordPress標準と異なる構造になる
2. **学習コスト**: 新規メンバーへの説明が必要
3. **ツール互換性**: 一部のWordPressツールが想定外動作の可能性
4. **アップデート影響**: WordPress本体更新時に注意が必要

## 代替案の再検討

移行のリスクとコストを考慮し、以下の代替案も検討価値があります：

### 代替案1: シンボリックリンク
```bash
ln -s wordpress/wp-content/themes/kei-portfolio themes
```
- メリット: 即座に実装可能、リスク最小
- デメリット: 本質的な解決ではない

### 代替案2: 環境変数での管理
```bash
export THEME_PATH="wordpress/wp-content/themes/kei-portfolio"
```
- メリット: 柔軟性が高い
- デメリット: 環境依存が増える

### 代替案3: 現状維持
- メリット: リスクゼロ、標準準拠
- デメリット: 階層が深いまま

## 結論

技術的には完全に移行可能であり、本実装計画に従えば安全に実施できます。ただし、以下の点を慎重に検討してください：

1. **投資対効果**: 3-6時間の作業時間に見合う価値があるか
2. **長期的影響**: 標準構造から逸脱することの将来的な影響
3. **チーム合意**: 開発チーム全体の理解と合意

移行を実施する場合は、この計画書に従い、段階的かつ慎重に進めることを強く推奨します。

## 付録: 影響ファイル完全リスト

### Docker関連（7ファイル）
1. docker-compose.yml
2. docker-compose.optimized.yml
3. docker-compose.simple.yml
4. docker-compose.yml.backup
5. Dockerfile
6. Dockerfile.backup
7. Dockerfile.optimized

### テスト関連（25+ ファイル）
- tests/bootstrap.php
- tests/*.php (22ファイル)
- tests/coverage/* (要再生成)
- tests/js/*.js (6ファイル)

### ドキュメント関連（30+ ファイル）
- README.md
- .gitignore
- docs/*.md
- tasks/*.md
- reports/*.md
- reviews/*.md
- learning/学習記録.md

### プロンプト・設定（3ファイル）
- プロンプト.md
- CLAUDE.md
- その他設定ファイル

合計: 約70ファイルに影響（直接的な修正が必要なのは10-15ファイル）