# ブログ監視機能実装仕様書

## 概要
WordPress kei-portfolioテーマに統一されたエラーログ、パフォーマンス監視、設定管理機能を追加しました。これらの機能により、本番環境でのサイト運営をより安全で効率的に行うことができます。

## 実装されたクラス

### 1. Blog_Logger クラス
**ファイル**: `/themes/kei-portfolio/inc/class-blog-logger.php`

#### 主な機能
- 統一されたログ管理（Debug, Info, Warning, Error, Critical）
- 自動ログローテーション
- WP_DEBUG環境での詳細ログ
- 本番環境での最適化されたログ
- 管理者への重要エラー通知
- セキュアなログファイル管理

#### 使用方法
```php
use KeiPortfolio\Blog\Blog_Logger;

$logger = Blog_Logger::get_instance();

// 各種ログレベル
$logger->debug('デバッグメッセージ', ['context' => 'additional_info']);
$logger->info('情報メッセージ');
$logger->warning('警告メッセージ');
$logger->error('エラーメッセージ');
$logger->critical('クリティカルエラー');
```

#### 設定
- **ログディレクトリ**: `wp-content/uploads/blog-logs/`
- **最大ファイルサイズ**: 5MB
- **ローテーションファイル数**: 5個
- **保持期間**: 30日

### 2. Blog_Performance_Monitor クラス
**ファイル**: `/themes/kei-portfolio/inc/class-blog-performance-monitor.php`

#### 主な機能
- ページ読み込み時間の監視
- データベースクエリの分析
- メモリ使用量の追跡
- カスタムメトリクスの記録
- パフォーマンス閾値の監視
- 日次パフォーマンスレポート生成

#### 使用方法
```php
use KeiPortfolio\Blog\Blog_Performance_Monitor;

$monitor = Blog_Performance_Monitor::get_instance();

// タイマーの使用
$monitor->start_timer('custom_operation');
// 処理...
$elapsed = $monitor->end_timer('custom_operation');

// メモリスナップショット
$monitor->record_memory_snapshot('checkpoint');

// カスタムメトリクス
$monitor->record_metric('api_calls', 10, ['endpoint' => '/api/data']);
```

#### デフォルト閾値
- **ページ読み込み時間**: 2.0秒
- **クエリ実行時間**: 0.1秒
- **クエリ数**: 50回
- **メモリ使用量**: 128MB
- **ピークメモリ**: 256MB

### 3. Blog_Config クラス
**ファイル**: `/themes/kei-portfolio/inc/class-blog-config.php`

#### 主な機能
- 全設定の一元管理
- 環境別設定の自動適用
- 設定値の検証
- 設定のエクスポート/インポート
- REST API経由の設定変更
- 設定変更時の自動処理実行

#### 使用方法
```php
use KeiPortfolio\Blog\Blog_Config;

$config = Blog_Config::get_instance();

// 設定値の取得
$posts_per_page = $config->get('display', 'posts_per_page', 10);

// 設定値の変更
$config->set('display', 'posts_per_page', 12);

// セクション全体の取得
$logging_config = $config->get('logging');
```

#### 設定セクション
1. **logging**: ログ関連設定
2. **performance**: パフォーマンス監視設定
3. **display**: 表示設定
4. **seo**: SEO関連設定
5. **cache**: キャッシュ設定
6. **security**: セキュリティ設定
7. **notifications**: 通知設定
8. **integrations**: 外部サービス連携
9. **advanced**: 高度な設定

## 環境別動作

### 開発環境 (WP_ENVIRONMENT_TYPE = 'development')
- 全ログレベルを記録
- デバッグ情報をHTML出力
- パフォーマンス監視有効
- キャッシュ無効
- 詳細エラー表示

### ステージング環境 (WP_ENVIRONMENT_TYPE = 'staging')
- InfoレベルからのログとうDB
- パフォーマンス監視有効
- XMLサイトマップ無効
- 基本的なキャッシュ有効

### 本番環境 (WP_ENVIRONMENT_TYPE = 'production')
- Warningレベル以上のログ
- デバッグ出力無効
- 全キャッシュ有効
- 圧縮・最適化有効
- 管理者への重要エラー通知

## WP_DEBUG環境での動作確認

### 確認済み項目
- ✅ クラスのシングルトンパターン動作
- ✅ ログファイルの自動生成とローテーション
- ✅ パフォーマンス測定の精度
- ✅ 設定値の検証と保存
- ✅ WordPress標準APIとの統合
- ✅ エラーハンドリングと例外処理
- ✅ セキュリティ対策（nonce、権限チェック等）

### テスト方法
テストファイルを使用して動作確認が可能です：
```bash
# ブラウザでアクセス
http://localhost/themes/kei-portfolio/test-blog-monitoring.php

# WP-CLI経由
wp eval-file themes/kei-portfolio/test-blog-monitoring.php
```

## 本番環境での最適化

### 1. ログ管理最適化
```php
// 本番環境では重要なログのみ記録
'logging' => [
    'enabled' => true,
    'level' => 'warning',  // warning以上のみ
    'max_file_size' => 2097152,  // 2MB
    'max_files' => 3,  // ローテーション数削減
    'enable_email_notifications' => true,
    'email_notification_level' => 'error',
]
```

### 2. パフォーマンス監視最適化
```php
// 本番環境では必要最小限の監視
'performance' => [
    'monitoring_enabled' => true,
    'enable_debug_output' => false,  // デバッグ出力無効
    'enable_daily_reports' => true,
    'thresholds' => [
        'page_load_time' => 3.0,  // 閾値を緩和
        'query_count' => 100,     // クエリ数制限を緩和
    ],
]
```

### 3. セキュリティ強化
```php
'security' => [
    'enable_rate_limiting' => true,
    'max_requests_per_minute' => 120,
    'enable_ip_blocking' => true,
    'enable_comment_moderation' => true,
]
```

### 4. キャッシュ戦略
```php
'cache' => [
    'enabled' => true,
    'ttl' => 7200,  // 2時間
    'enable_object_cache' => true,
    'enable_page_cache' => true,  // 本番環境でページキャッシュ有効
]
```

## ファイル構成

```
themes/kei-portfolio/
├── inc/
│   ├── class-blog-logger.php           # エラーログクラス
│   ├── class-blog-performance-monitor.php  # パフォーマンス監視クラス
│   └── class-blog-config.php           # 設定管理クラス
├── functions.php                       # クラス読み込み・初期化
└── test-blog-monitoring.php           # テストファイル
```

## 管理機能

### 1. WordPress管理画面
- **ダッシュボードウィジェット**: パフォーマンス状況の表示
- **設定ページ**: `設定 > Blog Config`
- **管理バーメニュー**: キャッシュクリア機能

### 2. REST API エンドポイント
```
GET /wp-json/blog/v1/config        # 設定取得
POST /wp-json/blog/v1/config       # 設定更新
```

### 3. AJAX エンドポイント
```javascript
// パフォーマンスデータ取得
wp.ajax.post('blog_performance_data', {
    nonce: blogAjax.nonce,
    data_type: 'current_metrics'
});

// 設定更新
wp.ajax.post('blog_update_config', {
    nonce: blogAjax.nonce,
    section: 'display',
    key: 'posts_per_page',
    value: 15
});
```

## セキュリティ対策

### 1. ログファイルの保護
- `.htaccess`による直接アクセス拒否
- `index.php`によるディレクトリリスティング防止
- ファイル拡張子の検証

### 2. 設定値の検証
- 入力値のサニタイゼーション
- 型と範囲の検証
- SQLインジェクション対策

### 3. アクセス制御
- nonce検証
- ユーザー権限チェック
- CSRF対策

## トラブルシューティング

### よくある問題

#### 1. ログファイルが生成されない
**原因**: 権限不足またはディスク容量不足
**対処法**:
```bash
# ディレクトリ権限確認
ls -la wp-content/uploads/
# 権限設定
chmod 755 wp-content/uploads/blog-logs/
```

#### 2. パフォーマンス監視が動作しない
**原因**: 監視が無効または閾値設定の問題
**対処法**:
```php
// 設定確認
$config = Blog_Config::get_instance();
$monitoring = $config->get('performance', 'monitoring_enabled');
```

#### 3. メモリ不足エラー
**原因**: ログやモニタリングデータの蓄積
**対処法**:
```php
// 古いログファイルの清掃
$logger = Blog_Logger::get_instance();
$logger->cleanup_old_logs();
```

## メンテナンス

### 定期実行推奨タスク

#### 毎日
- [ ] エラーログの確認
- [ ] パフォーマンスレポートの確認
- [ ] ディスク使用量の確認

#### 週次
- [ ] ログファイルのローテーション確認
- [ ] 設定値の見直し
- [ ] セキュリティアラートの確認

#### 月次
- [ ] 古いログファイルのアーカイブ
- [ ] パフォーマンス閾値の調整
- [ ] 設定のバックアップ

## バージョン情報

- **実装バージョン**: 1.0.0
- **対応WordPress**: 6.7以降
- **対応PHP**: 8.0以降（推奨8.2）
- **実装日**: 2025年1月8日

## サポートとドキュメント

詳細な技術情報や追加の設定オプションについては、各クラスファイル内のコメントを参照してください。また、テストファイルを定期的に実行して、システムの健全性を確認することを推奨します。