# 固定ページ自動作成機能 - 使用方法とトラブルシューティング

## 概要

kei-portfolioテーマの固定ページ自動作成機能は、テーマ有効化時に以下の固定ページを自動的に作成します：

- **About** (`/about`) - 自己紹介ページ
- **Skills** (`/skills`) - スキル一覧ページ
- **Contact** (`/contact`) - お問い合わせページ
- **Portfolio** (`/portfolio`) - ポートフォリオページ

## 実装ファイル

- **メイン機能**: `/inc/page-creator.php`
- **AJAXハンドラー**: `/inc/ajax-handlers.php`
- **テンプレートファイル**:
  - `/page.php` - 汎用ページテンプレート
  - `/page-about.php` - About専用テンプレート
  - `/page-skills.php` - Skills専用テンプレート
  - `/page-contact.php` - Contact専用テンプレート
  - `/page-portfolio.php` - Portfolio専用テンプレート

## 動作確認方法

### 1. テーマ有効化による自動作成

```bash
# WordPressの管理画面で以下を確認：
# 1. 外観 > テーマ で kei-portfolio を有効化
# 2. 固定ページ一覧で4つのページが作成されていることを確認
# 3. 外観 > メニュー で Primary Navigation メニューが作成されていることを確認
```

### 2. WordPressダッシュボードでの確認

1. **固定ページの確認**:
   - 管理画面 > 固定ページ
   - About, Skills, Contact, Portfolio の4ページが存在することを確認
   - 各ページのテンプレートが正しく設定されていることを確認

2. **メニューの確認**:
   - 管理画面 > 外観 > メニュー
   - "Primary Navigation" メニューが作成されていることを確認
   - メニュー項目に4つのページが追加されていることを確認

3. **フロントエンドでの確認**:
   - 各ページにアクセスして正常に表示されることを確認
   - `/about`, `/skills`, `/contact`, `/portfolio` のURLでアクセス可能

### 3. 手動でのテスト実行

```php
// functions.php または専用のテストファイルで実行
<?php
// 管理者権限が必要
if ( current_user_can( 'manage_options' ) ) {
    $results = kei_portfolio_manual_create_pages();
    var_dump( $results );
}
?>
```

### 4. PHPUnitテストの実行

```bash
cd /Users/kei/work/wordpress-site/themes/kei-portfolio

# 全テストの実行
./vendor/bin/phpunit tests/PageCreatorTest.php
./vendor/bin/phpunit tests/ContactFormHandlerTest.php

# 特定のテストメソッドのみ実行
./vendor/bin/phpunit tests/PageCreatorTest.php --filter test_create_all_pages
```

## WP-CLIでの確認

```bash
# 固定ページの一覧確認
wp post list --post_type=page

# 特定のページの詳細確認
wp post get --field=title --name=about
wp post get --field=post_status --name=skills

# メニューの確認
wp menu list
wp menu item list "Primary Navigation"

# ページテンプレートの確認
wp post meta get $(wp post list --post_type=page --name=about --field=ID) _wp_page_template
```

## お問い合わせフォームの動作確認

### 1. フロントエンドでのテスト

1. `/contact` ページにアクセス
2. フォームに必要項目を入力
3. 送信ボタンをクリック
4. 成功メッセージまたはエラーメッセージが表示されることを確認

### 2. AJAXリクエストのテスト

```javascript
// ブラウザのコンソールで実行
const formData = new FormData();
formData.append('action', 'kei_portfolio_contact_submit');
formData.append('contact_nonce', '<?php echo wp_create_nonce("kei_portfolio_contact"); ?>');
formData.append('contact_name', 'テストユーザー');
formData.append('contact_email', 'test@example.com');
formData.append('contact_subject', 'プロジェクトの相談');
formData.append('contact_message', 'テストメッセージです。');
formData.append('privacy_agreement', '1');

fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
    method: 'POST',
    body: formData
}).then(response => response.json())
.then(data => console.log(data));
```

## トラブルシューティング

### よくある問題と解決方法

#### 1. ページが作成されない

**症状**: テーマ有効化後もページが作成されない

**確認項目**:
```bash
# オプションの確認
wp option get kei_portfolio_pages_created

# エラーログの確認
tail -f /path/to/wordpress/debug.log | grep "Kei Portfolio"
```

**解決方法**:
1. `kei_portfolio_pages_created` オプションを削除して再実行
```bash
wp option delete kei_portfolio_pages_created
```

2. 手動で作成関数を実行
```php
if ( current_user_can( 'manage_options' ) ) {
    kei_portfolio_create_pages_on_activation();
}
```

#### 2. ページテンプレートが適用されない

**症状**: ページは作成されるが、専用テンプレートが適用されない

**確認項目**:
```bash
# テンプレートファイルの存在確認
ls -la page-*.php

# ページメタの確認
wp post meta get PAGE_ID _wp_page_template
```

**解決方法**:
1. テンプレートファイルが存在することを確認
2. 手動でテンプレートを再設定
```php
update_post_meta( $page_id, '_wp_page_template', 'page-about.php' );
```

#### 3. メニューに追加されない

**症状**: ページは作成されるが、メニューに追加されない

**確認方法**:
```bash
# メニューの存在確認
wp menu list

# メニューアイテムの確認
wp menu item list "Primary Navigation"
```

**解決方法**:
```php
// メニュー作成結果を確認し、手動で追加
$results = kei_portfolio_create_all_pages();
kei_portfolio_add_pages_to_menu( $results );
```

#### 4. お問い合わせフォームが動作しない

**症状**: フォーム送信時にエラーが発生する

**確認項目**:
1. AJAXアクションが登録されているか確認
2. ノンスが正しく生成されているか確認
3. wp_mailが正常に動作するか確認

```php
// AJAXアクションの確認
var_dump( has_action( 'wp_ajax_kei_portfolio_contact_submit' ) );
var_dump( has_action( 'wp_ajax_nopriv_kei_portfolio_contact_submit' ) );

// wp_mailのテスト
$test_mail = wp_mail( 
    'test@example.com', 
    'Test Subject', 
    'Test Message',
    array( 'Content-Type: text/plain; charset=UTF-8' )
);
var_dump( $test_mail );
```

#### 5. パーミッションエラー

**症状**: "Permission denied" エラーが発生

**確認項目**:
```bash
# ファイルパーミッションの確認
ls -la inc/page-creator.php
ls -la page-*.php

# ディレクトリパーミッションの確認
ls -ld /path/to/theme/
```

**解決方法**:
```bash
# 適切なパーミッションを設定
chmod 644 inc/page-creator.php
chmod 644 page-*.php
chmod 755 /path/to/theme/
```

### デバッグモードでの確認

WordPressのデバッグモードを有効にして詳細なエラー情報を取得：

```php
// wp-config.phpに追加
define( 'WP_DEBUG', true );
define( 'WP_DEBUG_LOG', true );
define( 'WP_DEBUG_DISPLAY', false );
```

ログファイルの場所：
- `/wp-content/debug.log`
- サーバーのエラーログファイル

### パフォーマンスの最適化

大量のページが存在する環境での最適化：

```php
// ページ検索時のパフォーマンス改善
function optimize_page_search() {
    // キャッシュを使用した検索
    $cached_pages = wp_cache_get( 'kei_portfolio_pages', 'kei_theme' );
    
    if ( false === $cached_pages ) {
        $cached_pages = get_posts( array(
            'post_type' => 'page',
            'name' => array( 'about', 'skills', 'contact', 'portfolio' ),
            'posts_per_page' => 4,
            'post_status' => 'any'
        ) );
        
        wp_cache_set( 'kei_portfolio_pages', $cached_pages, 'kei_theme', 3600 );
    }
    
    return $cached_pages;
}
```

## まとめ

この機能は以下の特徴を持ちます：

- **冪等性**: 何度実行しても安全
- **エラーハンドリング**: 適切なエラー処理とログ出力
- **セキュリティ**: ノンスによるCSRF対策、データサニタイゼーション
- **拡張性**: 新しいページの追加が容易
- **テスト済み**: 包括的なPHPUnitテストを実装

問題が発生した場合は、まずエラーログを確認し、必要に応じてデバッグモードを有効にして詳細な情報を取得してください。