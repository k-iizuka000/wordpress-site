# Claude エージェント作業フロー集

この文書は、`.claude/agents/` にあるエージェントを用いて開発・運用タスクを進めるための実務フローをまとめたものです。小規模開発・大規模開発・バグ修正・原因調査の標準手順と、必要に応じた追加エージェント提案を含みます。

## 共通原則（Quality Gates）
- 受け入れ基準: 作業開始前に明文化（成功条件・除外範囲）。
- 変更単位: 小さな差分でPRを作成、反復を早くする。
- レビュー観点: 設計妥当性／保守性／セキュリティ／テストの有無。
- テスト方針: 失敗時の最短再現手順＋回帰観点を残す（`tests/`）。
- ドキュメント: 永続資料は `docs/`、作業系は `tasks/` に保存。

## 主要エージェント（役割）
- 設計・テスト設計: `.claude/agents/wordpress-php-test-designer.md`
- 実装・修正: `.claude/agents/wordpress-fullstack-developer.md`
- 実装後コードレビュー: `.claude/agents/code-review-post-implementation.md`
- テスト実行: `.claude/agents/test-executor.md`
- テスト環境整備（Docker等）: `.claude/agents/test-environment-docker-architect.md`
- セキュリティ監査（開発後）: `.claude/agents/security-audit-post-development.md`
- ドキュメント管理: `.claude/agents/document-manager-ja.md`

補助: `.claude/agents/エージェント一覧.md` で説明を参照。

---

## 小規模開発フロー（半日〜3日）
1. 要件・受け入れ基準の整備（Document Manager）
   - `.claude/agents/document-manager-ja.md` を用い、目的・範囲・受け入れ基準を `tasks/` に簡潔に作成。
2. 実装設計（Test Designer）
   - `.claude/agents/wordpress-php-test-designer.md` で実装方針とテスト観点を設計。
3. 実装（Fullstack Developer）
   - `.claude/agents/wordpress-fullstack-developer.md` で小さなPR単位で実装。
4. 実装後レビュー（Code Review）
   - `.claude/agents/code-review-post-implementation.md` で差分レビュー。
5. レビュー修正（Fullstack Developer）
   - 指摘反映とテスト追加。
6. テスト実行（Test Executor）
   - `.claude/agents/test-executor.md` で単体/結合/簡易受け入れを実行。
7. 任意: セキュリティ軽量監査（Security Audit）
   - 公開面や権限周りに触れる変更時は `.claude/agents/security-audit-post-development.md`。

実行例（ユーザー指示の流れ）:
- 設計→実装→レビュー→修正→テスト実行 の順に、各エージェントへプロンプトを渡す。

---

## 大規模開発フロー（1週間〜）
0. 企画・分割（要追加: アーキテクト/リリース管理）
   - [要追加] `system-architect.md`: 全体設計・非機能要件・分割戦略。
   - [要追加] `release-manager.md`: ロールアウト計画・ロールバック設計。
1. 環境整備（Test Env Architect）
   - `.claude/agents/test-environment-docker-architect.md` でローカル/CI環境整備。
2. 各スライスの「設計→実装→レビュー→テスト」反復
   - 設計: `wordpress-php-test-designer.md`
   - 実装: `wordpress-fullstack-developer.md`
   - レビュー: `code-review-post-implementation.md`
   - テスト: `test-executor.md`
3. 統合テスト・非機能検証
   - [要追加] `performance-test-engineer.md`: 負荷/応答時間/リソース測定。
   - `.claude/agents/security-audit-post-development.md`: 脆弱性観点チェック。
   - [要追加] `migration-planner.md`: DB/データ移行の計画・検証。
4. 最終レビュー・リリース準備
   - レビュー集約・リリースノート作成（Document Manager）。
   - [要追加] Release Manager で段階的リリース計画とBackout手順。

---

## バグ修正フロー（Hotfix含む）
1. 症状記録・再現手順の最小化（Document Manager）
   - `tasks/` に再現条件・期待値・実際値・発生頻度を記載。
2. 失敗テストの追加（Test Designer）
   - `wordpress-php-test-designer.md` で再現テストを先に用意。
3. 修正（Fullstack Developer）
   - 最小差分で修正。関連回帰のテストも追加。
4. レビュー（Code Review）
   - 再現→原因→対策→再発防止（テスト）を重視して確認。
5. テスト実行（Test Executor）
   - 追加テスト＋回帰テストを実行。必要に応じセキュリティ軽点検。
6. 緊急度が高い場合の運用
   - [要追加] `incident-coordinator.md`: 連絡・一時回避策・リリース判断支援。

---

## 原因調査（RCA）フロー
1. 調査ゴール定義（Document Manager）
   - 影響範囲・仮説・検証基準を `tasks/` に定義。
2. 切り分け環境の準備（Test Env Architect）
   - `.claude/agents/test-environment-docker-architect.md` で最小再現環境を構築。
3. 実験設計・再現試行（Test Designer）
   - 観測ポイント（ログ/計測）と期待観測値を設計。
4. 分析・原因確定（調査結果の整理）
   - [要追加] `root-cause-analyst.md`: ログ相関・時系列・依存関係の分析。
5. 報告と次アクション（Document Manager）
   - 恒久対策・暫定対策・影響範囲・再発防止テスト案をまとめ、修正フローへ移行。

---

## テンプレ（プロンプト例の順序）
- 設計: 「対象機能の目的／受け入れ基準／テスト観点を設計して」→ Test Designer
- 実装: 「設計に沿って最小差分で実装して」→ Fullstack Developer
- レビュー: 「差分の設計・保守性・セキュリティ・テスト観点を確認して」→ Code Review
- 修正: 「レビュー指摘に沿って修正して」→ Fullstack Developer
- テスト: 「テストケースを実行し結果を要約して」→ Test Executor
- 環境: 「テスト用Docker環境を用意/更新して」→ Test Env Architect
- 監査: 「開発後の脆弱性リスクを洗い出して」→ Security Audit
- 文書: 「docs/tasks を規約に沿って整備して」→ Document Manager

---

## 追加が望ましいエージェント（提案）
- `system-architect.md`: 全体設計・非機能要件・分割戦略。
- `release-manager.md`: リリース/ロールバック計画、段階的配信。
- `performance-test-engineer.md`: 負荷・性能試験の計画と実行。
- `migration-planner.md`: データ移行/スキーマ変更の設計と検証。
- `incident-coordinator.md`: インシデント対応・利害関係者コミュニケーション。
- `root-cause-analyst.md`: 原因分析・計測設計・再発防止提案。

（本ドキュメントでは参照のみ。必要なら `.claude/agents/` に新規作成してください。）

---

## 運用メモ
- すべてのフローで「小さな差分」「反復」「明確な受け入れ基準」を徹底。
- セキュリティ/性能に関わる変更は、監査・負荷試験ステップを追加。
- 重要成果物は `docs/`、作業ログ/計画は `tasks/` に集約。

---

## 決定事項の反映（2025-08-09）
- 小規模フローの軽量セキュリティ監査: 現時点（未公開）は実施不要。公開前の段階から「常時実施（必須）」に切り替える。
- 大規模フローの非機能優先度: 性能＝高、セキュリティ＝高、可用性＝中。
  - 性能・セキュリティは統合段階で必須ゲート化。
  - 可用性は設計レビュー中心（System Architect/Release Manager）で担保。

### フローの追加/修正
【小規模（公開前以降）】
8. 公開前チェック（Security Audit: 必須）
   - `.claude/agents/security-audit-post-development.md` を用い、公開面/権限/入力検証/依存ライブラリの脆弱性を確認し、合否を記録。

【大規模】
3'. 性能試験（必須）
   - [要追加] `performance-test-engineer.md` で指標（応答時間/スループット/CPU・メモリ）と閾値を定義・実行。
3''. セキュリティ監査（必須）
   - `.claude/agents/security-audit-post-development.md` による静的/設定/依存の観点チェックを統合ゲートに組み込む。
4'. 可用性レビュー（設計観点）
   - [要追加] `system-architect.md` と `release-manager.md` を用い、フェイルオーバー/バックアップ/ロールバック手順を確認（中優先）。

---

## 最終エージェント一覧と現時点の採用判断
【必須（常時運用）】
- `.claude/agents/document-manager-ja.md`（ドキュメント管理）
- `.claude/agents/wordpress-php-test-designer.md`（実装/テスト設計）
- `.claude/agents/wordpress-fullstack-developer.md`（実装/修正）
- `.claude/agents/code-review-post-implementation.md`（実装後レビュー）
- `.claude/agents/test-executor.md`（テスト実行）

【準必須（大規模 or 公開前に必須）】
- `.claude/agents/test-environment-docker-architect.md`（環境整備; 統合/CI で必須）
- `.claude/agents/security-audit-post-development.md`（セキュリティ監査; 公開前以降は小規模でも必須）
- [要追加] `performance-test-engineer.md`（性能試験; 大規模で必須）
- [要追加] `release-manager.md`（リリース/ロールバック; 公開直前から必須）

【条件付き（案件条件が満たされたら導入）】
- [要追加] `system-architect.md`（全体設計/非機能; 複数スライス/高リスク案件）
- [要追加] `migration-planner.md`（DB/データ移行が発生する場合）
- [要追加] `root-cause-analyst.md`（深掘り調査が必要な恒久対策時）

【今は不要（現段階: 未公開）】
- [要追加] `incident-coordinator.md`（インシデント対応; 公開後/運用安定化フェーズで導入）
- [要追加] `release-manager.md`（直近の公開計画が固まるまでは任意; 公開直前に準必須へ昇格）
- [要追加] `migration-planner.md`（DB変更予定が立つまでは不要）

備考: 「要追加」は `.claude/agents/` に雛形を作成して導入可能。必要になった時点で追加する。
