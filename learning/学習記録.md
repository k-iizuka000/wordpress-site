## 2025-08-10 WordPress 公開失敗(503/403)の原因と恒久策

- 事象: Gutenberg で公開時に `POST /wp-json/wp/v2/posts/{id}/autosaves 503`、`block-patterns` 403、多数の REST 5xx が発生。画面は「正しい JSON レスポンスではありません」。
- 根因: 共有ホスティング(WAF/ModSecurity/LiteSpeed) が REST をブロック/変換。/wp-json 経路や JSON POST を誤検知。テーマ/プラグイン無効化でも再現。
- 恒久策: 管理画面限定で REST を admin-ajax 経由にプロキシし、WAF を回避。
  - `wp.apiFetch`/`window.fetch` をミドルウェアで `admin-ajax.php?action=kei_rest_proxy` に迂回
  - 必須ヘッダー付与: `X-Requested-With: XMLHttpRequest`, `X-KEIPORTFOLIO_REQUEST: 1`, `X-HTTP-Method-Override`
  - プロキシ側で `route` の URLデコードと `?` クエリの抽出・移送を実装
  - フロント影響を避けるため `rest_url` 書き換えは管理画面のみ/既定OFF
  - LiteSpeed の REST キャッシュ無効化を .htaccess に追加
- 代替案: サーバ側で `/wp-json/*` と `/?rest_route=*` をWAF除外できれば最小変更で解消可能（本環境はドメイン単位のみのため不採用）。
- 教訓: 共有環境でのGutenbergはREST依存が高く、WAF/CDN/キャッシュ層の影響が大きい。管理画面限定のプロキシ化は安全に効果を出しやすい。ルートのURLエンコード・クエリ移送の取りこぼしに注意。

