# WordPress テーマ kei-portfolio Docker テスト環境状況

## 環境構築日時
作成日: 2025年8月7日  
作成者: Claude Code  

## 環境概要

WordPress テーマ「kei-portfolio」用の完全なDocker化テスト環境を構築しました。この環境は開発、テスト、本番の各ステージに対応したマルチステージビルドを採用しています。

## 構築された環境とツール

### 1. PHP環境 (WordPress用)

- **PHP**: 8.2 (Apache付き)
- **PHPUnit**: 9.5以上 + WordPress Test Suite
- **PHP CodeSniffer**: 3.7以上 + WordPress Coding Standards  
- **PHPStan**: 1.10以上 (静的解析)
- **Composer**: 2.x (依存関係管理)

### 2. JavaScript/Node.js環境

- **Node.js**: 18 LTS版
- **Jest**: JavaScriptユニットテスト
- **ESLint**: @wordpress/eslint-plugin付き
- **Stylelint**: @wordpress/stylelint-config付き
- **Webpack**: ビルドツール

### 3. WordPress環境

- **WordPress**: 最新版
- **WP-CLI**: コマンドラインツール
- **MariaDB**: 10.11 (テスト用はtmpfs使用)
- **Redis**: 7 (キャッシュ用)

### 4. 追加ツール

- **Lighthouse**: パフォーマンステスト
- **axe-core / pa11y**: アクセシビリティテスト
- **@wordpress/env**: WordPress開発環境
- **phpMyAdmin**: データベース管理（開発環境のみ）
- **MailHog**: メールテスト（開発環境のみ）

## Docker構成

### マルチステージビルド構成

1. **base**: 共通の基底イメージ
2. **node-stage**: Node.js/npmビルド環境
3. **development**: 開発環境 (デフォルト)
4. **testing**: テスト環境
5. **production**: 本番環境

### コンテナサービス

#### 開発環境 (docker-compose.yml)
- `wordpress`: メインのWordPress開発環境
- `db`: MariaDBデータベース
- `redis`: Redisキャッシュ
- `phpmyadmin`: データベース管理UI
- `mailhog`: メールテスト環境
- `node`: アセット監視・ビルド
- `nginx`: リバースプロキシ

#### テスト環境 (docker-compose.test.yml)
- `wordpress-test`: テスト用WordPress
- `db-test`: テスト専用データベース (tmpfs使用)
- `phpunit`: PHPUnitテスト実行
- `jest`: Jestテスト実行
- `eslint`: ESLint実行
- `stylelint`: Stylelint実行
- `phpcs`: PHP CodeSniffer実行
- `phpstan`: PHPStan静的解析
- `lighthouse`: パフォーマンステスト
- `axe-test`: アクセシビリティテスト (axe-core)
- `pa11y`: アクセシビリティテスト (pa11y)
- `test-reporter`: テストレポート集約

## 作成されたファイル

### Docker関連
- `/Users/kei/work/wordpress-site/Dockerfile` - マルチステージビルドファイル
- `/Users/kei/work/wordpress-site/docker-compose.yml` - 開発環境定義
- `/Users/kei/work/wordpress-site/docker-compose.test.yml` - テスト環境定義
- `/Users/kei/work/wordpress-site/apache-config.conf` - Apache設定
- `/Users/kei/work/wordpress-site/.dockerignore` - Docker除外ファイル

### 設定ファイル
- `/Users/kei/work/wordpress-site/wordpress/wp-content/themes/kei-portfolio/composer.json` - PHP依存関係
- `/Users/kei/work/wordpress-site/wordpress/wp-content/themes/kei-portfolio/package.json` - npm依存関係
- `/Users/kei/work/wordpress-site/wordpress/wp-content/themes/kei-portfolio/phpunit.xml` - PHPUnit設定
- `/Users/kei/work/wordpress-site/wordpress/wp-content/themes/kei-portfolio/jest.config.js` - Jest設定

### テストスクリプト
- `/Users/kei/work/wordpress-site/run-tests.sh` - テスト実行スクリプト (実行権限付与済み)

## PHP依存関係 (composer.json)

### 本番環境
- `php: >=8.0`
- `composer/installers: ^2.0`

### 開発・テスト環境
- `phpunit/phpunit: ^9.5`
- `yoast/phpunit-polyfills: ^1.1`
- `squizlabs/php_codesniffer: ^3.7`
- `wp-coding-standards/wpcs: ^3.0`
- `phpcompatibility/php-compatibility: ^9.3`
- `phpstan/phpstan: ^1.10`
- `szepeviktor/phpstan-wordpress: ^1.3`
- `brain/monkey: ^2.6`
- `mockery/mockery: ^1.6`

## JavaScript依存関係 (package.json)

### 開発・テスト環境
- `@wordpress/scripts: ^26.15.0`
- `@wordpress/env: ^8.7.0`
- `@wordpress/eslint-plugin: ^17.2.0`
- `@wordpress/stylelint-config: ^21.15.0`
- `jest: ^29.7.0`
- `@testing-library/jest-dom: ^6.1.0`
- `lighthouse: ^11.2.0`
- `axe-core: ^4.8.0`
- `pa11y: ^7.0.0`

### 本番依存関係
- `bootstrap: ^5.3.0`
- `swiper: ^10.3.0`

## テストスクリプト

### Composer スクリプト
```bash
composer run test:all      # すべてのPHPテスト実行
composer run test:php      # PHPUnitテスト
composer run lint:php      # PHPCS実行
composer run analyze       # PHPStan実行
composer run ci           # CI パイプライン
```

### npm スクリプト
```bash
npm run test              # Jestテスト
npm run test:coverage     # カバレッジ付きテスト
npm run lint              # 全リンター実行
npm run lint:js           # ESLint実行
npm run lint:css          # Stylelint実行
npm run performance       # Lighthouse実行
npm run test:a11y         # axe-core実行
npm run test:pa11y        # pa11y実行
```

### run-tests.sh スクリプト
```bash
./run-tests.sh all                    # すべてのテスト実行
./run-tests.sh php --verbose          # PHPテストを詳細出力で実行
./run-tests.sh js                     # JavaScriptテストのみ
./run-tests.sh lint                   # リンターのみ
./run-tests.sh coverage               # カバレッジレポート生成
./run-tests.sh performance            # パフォーマンステスト
./run-tests.sh a11y                   # アクセシビリティテスト
./run-tests.sh --setup                # WordPress Test Suite セットアップ
```

## ポート設定

### 開発環境
- WordPress: http://localhost:8080
- phpMyAdmin: http://localhost:8081
- MailHog UI: http://localhost:8025
- Webpack Dev Server: http://localhost:3000
- Nginx: http://localhost:80, https://localhost:443
- MySQL: localhost:3306
- Redis: localhost:6379
- SMTP (MailHog): localhost:1025

### テスト環境
- 独立したネットワーク (172.21.0.0/16) で実行

## ボリューム設定

### 開発環境
- `wordpress_data`: WordPress本体データ
- `db_data`: MariaDBデータ
- `redis_data`: Redisデータ
- テーマファイル: ホットリロード対応でマウント

### テスト環境
- `test_coverage`: テストカバレッジレポート
- `lighthouse_reports`: Lighthouseレポート
- `axe_reports`: axe-coreレポート
- `pa11y_reports`: pa11yレポート

## 環境設定

### 開発環境変数
```
WORDPRESS_DEBUG=1
WORDPRESS_DEBUG_LOG=1
WORDPRESS_DEBUG_DISPLAY=1
WP_ENVIRONMENT_TYPE=development
NODE_ENV=development
```

### テスト環境変数
```
NODE_ENV=test
CI=true
WP_TESTS_DOMAIN=localhost
WP_TESTS_EMAIL=admin@kei-portfolio-test.local
```

## セキュリティ設定

### Apache セキュリティヘッダー
- X-Content-Type-Options: nosniff
- X-Frame-Options: DENY  
- X-XSS-Protection: 1; mode=block

### PHP セキュリティ設定
- 開発環境: エラー表示ON、詳細ログ出力
- 本番環境: エラー表示OFF、OPcache最適化

## パフォーマンス最適化

### Apache設定
- Gzip圧縮有効
- ブラウザキャッシュ設定 (CSS/JS: 1ヶ月)
- 画像キャッシュ設定 (画像: 1ヶ月)

### PHP設定  
- OPcache有効 (本番環境)
- メモリ制限: 1024M (テスト環境)

### データベース設定
- テスト環境: tmpfs使用で高速化
- 文字セット: utf8mb4
- 照合順序: utf8mb4_unicode_ci

## テストカバレッジ目標

### PHP (PHPUnit)
- 全体: 75%以上
- 主要機能: 80%以上

### JavaScript (Jest)
- 全体: 75%以上  
- 主要スクリプト: 80%以上

## 品質管理

### Linting設定
- **PHPCS**: WordPress Coding Standards準拠
- **ESLint**: @wordpress/eslint-plugin使用
- **Stylelint**: @wordpress/stylelint-config使用
- **Prettier**: コード整形

### 静的解析
- **PHPStan**: レベル6で実行
- **WordPress関数**: szepeviktor/phpstan-wordpress使用

### アクセシビリティ
- **axe-core**: WCAG 2.1 AA準拠チェック
- **pa11y**: 自動アクセシビリティテスト

### パフォーマンス
- **Lighthouse**: Performance/Accessibility/Best Practices/SEO
- 目標スコア: 各項目90以上

## 環境ステータス

✅ **構築完了**: すべてのDockerファイルと設定ファイルが作成済み  
✅ **テスト設定**: PHPUnit、Jest、Linting設定完了  
✅ **スクリプト**: run-tests.sh テスト実行スクリプト作成済み  
✅ **マルチステージ**: 開発・テスト・本番環境対応  
✅ **ホットリロード**: 開発時のファイル変更監視対応  
✅ **CI/CD対応**: 各種レポート出力とCI環境設定  

## 次のステップ

1. Docker環境の起動とテスト実行
2. テストケースの作成 (PHP/JavaScript)  
3. CI/CDパイプラインの設定
4. セキュリティスキャンの実装
5. パフォーマンスベンチマークの設定

## 注意点

- 初回起動時はWordPress Test Suiteのセットアップが必要
- テスト用データベースはtmpfsを使用するため、コンテナ停止時にデータは消去される
- 開発環境のデータベースは永続化されている
- セキュリティ設定は本番環境での使用を想定している