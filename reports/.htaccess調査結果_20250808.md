# .htaccessファイル調査レポート

作成日: 2025年8月8日

## 調査結果サマリー

### 問題の概要
WordPressサイトのエクスポート処理において、.htaccessファイルが適切にコピーされていない問題を調査しました。

### 調査で判明した事実

1. **現在の.htaccessファイルの所在**
   - `/Users/kei/work/wordpress-site/old/.htaccess` に完全な.htaccessファイルが存在
   - `/Users/kei/work/wordpress-site/wordpress/` ディレクトリには.htaccessファイルが**存在しない**
   - `/Users/kei/work/wordpress-site/themes/kei-portfolio/` ディレクトリにも.htaccessファイルは**存在しない**

2. **エクスポートスクリプトの動作**
   - `export-wordpress-site.sh`スクリプトは`.htaccess-for-root`という名前でファイルを**新規作成**している
   - 既存の.htaccessファイルをコピーする処理は**実装されていない**
   - エクスポート先には`htaccess-root`という名前でファイルが作成されている

3. **Docker環境の設定**
   - Docker環境では`apache-config.conf`でRewriteルールを直接設定
   - .htaccessファイルは使用していない（AllowOverride Allは設定済み）

## 問題の根本原因

### 1. 開発環境と本番環境の差異
- **開発環境（Docker）**: Apache設定ファイルで直接Rewriteルールを定義
- **本番環境（通常のホスティング）**: .htaccessファイルが必要

### 2. スクリプトの設計思想
- エクスポートスクリプトは既存ファイルのコピーではなく、必要な内容を**新規生成**する設計
- これは開発環境に.htaccessファイルが存在しないことを前提とした正しい動作

### 3. ファイル名の不一致
- スクリプト内では`.htaccess-for-root`として作成
- エクスポート先では`htaccess-root`として保存
- 本番環境では`.htaccess`という名前が必要

## 現在の.htaccessファイル内容の比較

### old/.htaccessファイル（フル機能版）
```apache
# BEGIN WordPress
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>
# END WordPress

# Security Headers
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    Header set Content-Security-Policy "upgrade-insecure-requests"
</IfModule>

# Protect important files
<FilesMatch "^(wp-config\.php|\.htaccess)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Block access to PHP files in themes directory (except index.php)
<FilesMatch "\.php$">
    Order Allow,Deny
    Deny from all
</FilesMatch>
<FilesMatch "^(index\.php|functions\.php|page.*\.php|single.*\.php|archive.*\.php|header\.php|footer\.php|sidebar\.php|404\.php|search\.php|comments\.php)$">
    Order Allow,Deny
    Allow from all
</FilesMatch>

# Disable directory browsing
Options -Indexes

# GZIP Compression
<IfModule mod_deflate.c>
    [圧縮設定]
</IfModule>

# Cache Control
<IfModule mod_expires.c>
    [キャッシュ設定]
</IfModule>
```

### エクスポートスクリプトが生成する.htaccess（簡易版）
```apache
# BEGIN WordPress
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>
# END WordPress

# Security Headers
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
</IfModule>

# Protect important files
<FilesMatch "^(wp-config\.php|\.htaccess)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Disable directory browsing
Options -Indexes

# GZIP Compression
<IfModule mod_deflate.c>
    [圧縮設定]
</IfModule>

# Cache Control
<IfModule mod_expires.c>
    [キャッシュ設定]
</IfModule>
```

### 主な違い
1. **セキュリティヘッダー**: 簡易版では`Referrer-Policy`と`Content-Security-Policy`が欠落
2. **PHPファイルアクセス制限**: 簡易版ではテーマディレクトリ内のPHPファイルへのアクセス制限が欠落

## 推奨される解決策

### 即時対応（現在のエクスポートを本番環境に適用する場合）

1. **手動での.htaccessファイル設置**
   ```bash
   # 本番環境のWordPressルートディレクトリで実行
   cd /path/to/wordpress/
   
   # エクスポートされたhtaccess-rootファイルをコピー
   cp /path/to/export/htaccess-root .htaccess
   
   # パーミッション設定
   chmod 644 .htaccess
   chown www-data:www-data .htaccess
   ```

2. **より完全な.htaccessを使用する場合**
   ```bash
   # old/.htaccessファイルを使用（より多くのセキュリティ設定を含む）
   cp /Users/kei/work/wordpress-site/old/.htaccess /path/to/wordpress/.htaccess
   ```

### スクリプト改善案

`export-wordpress-site.sh`の修正提案:

```bash
# 197行目以降を修正

# .htaccess ファイルをエクスポート先に直接作成
info_msg ".htaccess ファイルをエクスポート先に作成中..."

# oldディレクトリの.htaccessを優先的に使用
if [ -f "/Users/kei/work/wordpress-site/old/.htaccess" ]; then
    cp "/Users/kei/work/wordpress-site/old/.htaccess" "$EXPORT_DIR/$DATE/.htaccess"
    success_msg "既存の.htaccessファイルをコピー"
else
    # 既存ファイルがない場合は新規作成
    cat > "$EXPORT_DIR/$DATE/.htaccess" << 'HTACCESS_EOF'
[現在の.htaccess-for-rootの内容]
HTACCESS_EOF
    success_msg ".htaccessファイルを新規作成"
fi

# テーマディレクトリにもコピー（バックアップ用）
cp "$EXPORT_DIR/$DATE/.htaccess" "$THEME_UPLOAD_DIR/.htaccess-for-root"
```

### 本番環境移行時のチェックリスト

1. **必須確認事項**
   - [ ] WordPressルートディレクトリに`.htaccess`ファイルが存在する
   - [ ] ファイルパーミッションが644に設定されている
   - [ ] 所有者がWebサーバーユーザー（www-data等）に設定されている
   - [ ] mod_rewriteモジュールが有効になっている
   - [ ] AllowOverride Allが設定されている

2. **動作確認**
   - [ ] 固定ページへのアクセスが正常に動作する
   - [ ] パーマリンク設定が正しく機能する
   - [ ] 404エラーページが適切に表示される
   - [ ] セキュリティヘッダーが適用されている（開発者ツールで確認）

## セキュリティ考慮事項

### 推奨される.htaccess設定

本番環境では、以下の設定を含む完全版の.htaccessを使用することを推奨:

1. **基本的なWordPress設定**（必須）
2. **セキュリティヘッダー**（推奨）
   - X-Content-Type-Options
   - X-Frame-Options
   - X-XSS-Protection
   - Referrer-Policy
   - Content-Security-Policy

3. **ファイルアクセス制限**（強く推奨）
   - wp-config.phpへのアクセス禁止
   - テーマディレクトリ内の不要なPHPファイルへのアクセス制限

4. **パフォーマンス最適化**（推奨）
   - GZIP圧縮
   - ブラウザキャッシュ制御

## まとめ

.htaccessファイルがコピーされていない問題は、開発環境（Docker）と本番環境の構成の違いに起因する設計上の仕様であることが判明しました。エクスポートスクリプトは正常に動作しており、本番環境用の.htaccessファイルを生成していますが、ファイル名と配置場所の調整が必要です。

### 今後の対応
1. エクスポートスクリプトを改善し、.htaccessファイルを適切な名前で直接エクスポートディレクトリに配置
2. 既存の`old/.htaccess`ファイルを活用し、より完全なセキュリティ設定を維持
3. 移行手順書に.htaccessファイルの設置手順を明確に記載