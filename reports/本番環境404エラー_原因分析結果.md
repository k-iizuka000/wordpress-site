# 本番環境404エラー 原因分析結果

## 調査日時
2025年1月8日

## 問題の概要
- **現象**: 本番環境で[about][skills][contact][portfolio]ページが404エラーになる
- **環境**: ローカル環境では正常に表示される
- **影響範囲**: ナビゲーションメニューからアクセスする主要ページすべて

## 調査結果

### 1. 技術的な原因分析

#### 根本原因
**WordPressの固定ページがデータベースに存在しない**

テーマファイル（page-about.php等）は存在するが、対応する固定ページのデータベースレコード（wp_postsテーブル）が作成されていない。

#### 詳細な原因の解明

##### 1.1 after_switch_themeフックの動作条件
```php
// inc/page-creator.php line 254
add_action('after_switch_theme', 'kei_portfolio_create_pages_on_activation');
```

このフックは以下の条件でのみ発火する：
- WordPress管理画面からテーマを切り替えた時
- wp-cli でテーマを有効化した時

**発火しない条件：**
- FTPでテーマファイルをアップロードした時
- ファイルマネージャーでテーマを配置した時
- export-wordpress-site.shでファイルをコピーした時

##### 1.2 ページ作成メカニズムの分析

現在の実装では、以下の流れでページが作成される：

1. テーマ有効化時: `after_switch_theme`フックが発火
2. `kei_portfolio_create_pages_on_activation()`が実行
3. `kei_portfolio_create_all_pages()`でページ作成
4. 各ページに対して`wp_insert_post()`でデータベースに登録
5. ページテンプレート（page-about.php等）をメタデータとして設定

### 2. 環境による差異

| 項目 | ローカル環境 | 本番環境 |
|------|------------|----------|
| テーマ導入方法 | 開発環境で直接作成 | ファイルアップロード |
| after_switch_theme発火 | ○（開発時に発火済み） | ✗（ファイルアップロードでは発火しない） |
| 固定ページの存在 | ○（データベースに存在） | ✗（データベースに存在しない） |
| テンプレートファイル | ○ | ○ |
| 404エラー | 発生しない | 発生する |

### 3. WordPressのページ解決メカニズム

WordPressがページをレンダリングする際の処理フロー：

1. **URLのパース**: `/about`というURLを受信
2. **リライトルールの適用**: .htaccessでindex.phpにリライト
3. **クエリの実行**: `get_page_by_path('about')`でデータベースを検索
4. **ページの取得**:
   - ページが存在する場合 → テンプレート（page-about.php）を読み込み
   - ページが存在しない場合 → **404エラー**

### 4. 関連する問題

#### 4.1 パーマリンク設定
- リライトルールがキャッシュされている可能性
- .htaccessファイルが更新されていない可能性

#### 4.2 キャッシュの影響
- **サーバーサイドキャッシュ**: Varnish、Redis等
- **CDNキャッシュ**: CloudFlare等
- **WordPressキャッシュ**: オブジェクトキャッシュ、トランジェント

### 5. Web検索による一般的な原因

WordPress 404エラーの一般的な原因（検索結果より）：

1. **パーマリンク設定の問題**（最も一般的）
   - 解決策: 設定 > パーマリンクで「変更を保存」をクリック

2. **.htaccessファイルの破損**
   - 解決策: .htaccessファイルを再生成

3. **プラグインの競合**
   - 解決策: プラグインを無効化して確認

4. **テーマの問題**
   - 解決策: デフォルトテーマに切り替えて確認

### 6. 診断結果

#### 確定した原因
1. **主原因**: 固定ページがデータベースに作成されていない
2. **副原因**: after_switch_themeフックが本番環境で発火していない
3. **影響要因**: デプロイ方法（ファイルアップロード）の問題

#### 除外された原因
- テンプレートファイルの欠損（ファイルは存在する）
- PHPエラー（エラーログに記録なし）
- パーミッションの問題（他のページは表示される）

## 推奨される解決方法

### 即時対応
1. WordPress管理画面から手動で固定ページを作成
2. パーマリンク設定をリフレッシュ

### 恒久対応
1. 自動ページ作成機能の改善（initフックでの確認処理追加）
2. 管理画面にページ作成ツールを追加
3. デプロイプロセスの改善（wp-cliの活用等）

## 学習ポイント

1. **after_switch_themeフックの制限**
   - ファイルベースのデプロイでは機能しない
   - 代替手段の実装が必要

2. **本番環境へのデプロイ戦略**
   - データベース操作を含む機能は特別な配慮が必要
   - マイグレーション機能の実装を検討

3. **エラーハンドリングの重要性**
   - ページが存在しない場合の自動作成機能
   - ユーザーフレンドリーなエラーメッセージ