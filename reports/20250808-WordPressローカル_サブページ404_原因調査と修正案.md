# WordPressローカル環境「サブページが404」原因調査と修正案（kei-aokiki.dev 対比）

## 1. 初期要求の記録（チェックリスト）
- 対象: 本番 `https://kei-aokiki.dev/` と ローカル `http://localhost:8090/`
- 事象: 「製作実績」などのサブページがローカルで 404
- ツール: `export-wordpress-site.sh`
- 目的: 原因の特定と修正案の提示（再発防止含む）

注: ネットワーク制限により大規模なWeb検索は制約あり。一般的なWordPress知見と本リポジトリの構成確認から結論を導出。

## 2. 現状把握（リポジトリと環境）
- コンテナ: `wordpress:6.4-php8.2-apache`（Docker）
  - `Dockerfile.optimized`: `a2enmod rewrite headers expires deflate` を実施
  - `apache-config.conf`: `<Directory /var/www/html> AllowOverride All` および WordPress向け Rewrite 設定あり
- テーマ: `themes/kei-portfolio`
  - `inc/post-types.php` でカスタム投稿タイプ `project`（実績）を登録
    - `rewrite: { slug: 'projects' }`、`has_archive: true`
    - アーカイブ: `/projects/`、個別ページ: `/projects/{slug}/`
  - テンプレートあり: `archive-project.php`, `single-project.php`
- パーマリンク: 本番用エクスポートSQLには `permalink_structure='/%postname%/'` が含まれる
- エクスポートスクリプト: `export-wordpress-site.sh`
  - DBエクスポート後、URLを `http://localhost:8090` → `https://kei-aokiki.dev` に置換（本番用）
  - `.htaccess-for-root` を生成（WP標準のリライトルールを含む）

## 3. 事象の解釈と主要な原因仮説
「トップは表示できるが、サブページ（特に実績CPT関連）が404」から、以下が有力。
- 仮説A: ローカルのパーマリンク設定が未構成 or リライトルール未フラッシュ
  - 症状: 固定ページ/CPTのパス型URLが404（クエリ式 `?p=ID` は表示可）
- 仮説B: `.htaccess` がWordPressルートに存在しない/無効（mod_rewrite 未動作）
  - 症状: すべての「きれいなURL」で404
- 仮説C: CPT登録後にリライトルール未更新（テーマ切替・CPT変更直後）
  - 症状: CPTアーカイブ/個別のみ404
- 仮説D: コンテンツ不足/スラッグ不一致
  - 症状: アーカイブは開くが、個別のみ404（該当投稿が未公開/ドラフト）
- 仮説E: サイトURL(siteurl/home)不整合によるリダイレクト→404
  - 症状: リダイレクトループや意図しないドメイン遷移後の404

本リポジトリとDocker/Apache設定から、Bは可能性低め（rewrite有効・AllowOverride All）。最有力はA/C、次点がD、Eは設定誤り時に限り発生。

## 4. 確認ポイント（ローカルでの具体的検証手順）
1) パーマリンク設定の保存（フラッシュ）
- 管理画面 → 設定 → パーマリンク → 「投稿名」を選択 → 変更がなくても「変更を保存」
- 代替（WP-CLI）: `wp rewrite flush --hard`

2) `.htaccess` の存在と内容
- WordPressルートに以下の標準ブロックがあることを確認（概略）
  ```
  # BEGIN WordPress
  <IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  RewriteRule ^index\.php$ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule . /index.php [L]
  </IfModule>
  # END WordPress
  ```

3) CPTリライトルールの更新
- テーマ有効化直後に `flush_rewrite_rules()` を実行（再発防止策は後述）

4) コンテンツ存在確認
- 管理画面で「実績（Projects）」の公開済み投稿が1件以上あるか確認
- ない場合は1件作成して個別ページが表示されるか確認

5) サイトURLの整合性
- ローカルでは `siteurl` と `home` が `http://localhost:8090` になっているか（WP-CLI: `wp option get siteurl` / `home`）

## 5. 原因の結論（最可能性）
- 第一候補: ローカル環境のパーマリンク設定/リライトルール未反映（A/C）
  - 理由: テーマはCPTを提供し、Apache側もrewrite有効。DBに本番向けの`permalink_structure`が含まれる一方、ローカルのDBは別でありうるため、ローカル側での「保存（flush）」が未実施だとCPT配下やサブページが404になりやすい。
- 第二候補: 実績（Projects）のコンテンツ未作成（D）
  - 理由: CPTは存在するが、投稿ゼロやドラフトのみだと、アーカイブや個別が404になりがち。

## 6. 修正案（優先度順の実行手順）
- 手順1: パーマリンク設定を保存（flush）
  - 管理画面から保存、または WP-CLI: `wp rewrite flush --hard`
- 手順2: `.htaccess` を確認/設置
  - ルートに標準のWPリライトブロックがあるか確認。なければ上記ブロックを作成
- 手順3: 実績（Projects）投稿を1件以上公開
  - WP-CLI例: `wp post create --post_type=project --post_status=publish --post_title='Sample Project'`
- 手順4: サイトURLの整合確認
  - `wp option get siteurl` / `home` がローカルURLになっているか。違う場合は `wp option update siteurl 'http://localhost:8090'` / `home` を実施
- 手順5: テーマ側の再発防止（推奨実装）
  - テーマ有効化フックでCPT登録後に `flush_rewrite_rules()` を1回呼び出す（`after_switch_theme` アクション）

## 7. 再発防止（運用/コードの観点）
- 運用
  - テーマやCPTを変更したら、管理画面でパーマリンク設定を必ず保存
  - ローカル初期セットアップに「パーマリンク保存」と「実績1件投入」を含める
- コード
  - `after_switch_theme` で `flush_rewrite_rules()` を実行
  - 初期データ投入用スクリプト（Projectsサンプル）の用意
- スクリプト
  - `export-wordpress-site.sh` は本番用URLへの置換を行うため、ローカルへ戻すインポート時の手順をdocsに明記（siteurl/homeの戻し方）
  - 絶対パスのハードコードを避け、環境変数経由に置換（セキュリティ/可搬性）

## 8. 付記（`export-wordpress-site.sh` について）
- 本スクリプトは「本番用エクスポート」に特化し、DB内URLを `https://kei-aokiki.dev` へ置換する挙動を含む。
- ローカル検証に使用する場合は、インポート後に `siteurl/home` をローカルへ戻すか、置換を行わないエクスポートモードの用意が望ましい。

## 9. 次アクション（依頼事項）
- [ ] ローカルでパーマリンク保存（flush）を実施して改善するか確認
- [ ] `.htaccess` の有無と内容を確認
- [ ] Projects投稿が存在しない場合は1件作成して確認
- [ ] 必要ならテーマに `after_switch_theme` で `flush_rewrite_rules()` を追加（ご希望あればPR化します）

---
作成日: 2025-08-08  / 作成者: （本ドキュメント自動生成）
