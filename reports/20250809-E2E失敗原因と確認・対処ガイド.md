# E2Eテスト失敗の原因特定レポート（確認・対処ガイド付き）

最終更新: 2025-08-09

## 概要
- 事象: `BASE_URL=http://localhost:8090 ./run-tests.sh e2e` が失敗する。
- 状況: コミット `7d03097`, `f8e2762`, `59045e2` 付近の変更後に発生。
- 結論（最有力因子）:
  - E2Eが Docker ログ中の`[error]`を1行でも検出すると失敗する仕様で、直近の「セキュリティ強化（.htaccessやCSP/権限）」によりApacheの[error]系ログが増加 → 画面は表示されていても失敗判定になっている可能性が高い。
- 次点の因子:
  - REST APIの権限/Nonce強化により、Gutenberg関連（`templates/lookup`等）や投稿APIで403→コンソールエラー化。
  - CSPヘッダーの二重/過剰設定により、一部外部接続やinline/evalがブロック→コンソールエラー化。
  - X-Frame-Optionsの厳格化により、iframe/プレビュー系での失敗。

## 影響範囲と関連コミット
- `7d03097` ブログ機能追加と合わせ、テーマ配下`.htaccess`/セキュリティ強化が導入。
- `f8e2762` REST API 403一時対応（`inc/rest-api-permissions.php` 等）を追加。
- `59045e2` 公開ボタンの無限ループ修正に合わせ、`secure-nonce-handler.php` 等の権限/Nonce周辺を拡張。

## 技術的根拠（リポジトリ内参照）
- E2Eの失敗条件:
  - `themes/kei-portfolio/tests/e2e/crawl-and-check.js`
    - Dockerログを `docker logs <container> --since <start>` で収集。
    - `"[error]"` を含む行を検出し、1件でもあれば `pagesFailed>0 || dockerErrorCount>0` で `process.exit(1)`。
- セキュリティ強化に伴う[error]誘発要因:
  - テーマ直下/アセット配下 `.htaccess` による直接アクセス拒否・MIME厳格化。
    - `themes/kei-portfolio/.htaccess`, `themes/kei-portfolio/assets/.htaccess`
  - サーバ/テーマ双方からのCSP送出（設定差異の可能性）。
    - サーバ: `apache-config.conf`
    - テーマ: `themes/kei-portfolio/inc/security.php`, `themes/kei-portfolio/inc/class-security-helper.php`
  - REST APIの権限/Nonce強化:
    - `themes/kei-portfolio/inc/rest-api-permissions.php`, `themes/kei-portfolio/inc/secure-nonce-handler.php`

## 確認方法（手順）
1) E2E実行と結果ファイルの確認
- 実行: `BASE_URL=http://localhost:8090 ./run-tests.sh e2e`
- 出力: `themes/kei-portfolio/tests/e2e/結果_YYYYMMDD-hhmm.json`
  - `summary.dockerErrorCount` と `dockerErrorLines` を確認し、どの種類の[error]が出ているか特定（例: `client denied by server configuration`, `CSP`違反, `403` など）。

2) Dockerログの直接確認（E2E時間帯に限定）
- 例: `docker logs kei-portfolio-dev --since "2025-08-09T12:00:00Z" | grep -i "\[error\]"`
- 上記のエラーパターン（拒否/403/CSP）を分類し、テストクロール時のどのアクセスで発生したかを推定。

3) 画面側の失敗要因の切り分け
- コンソールエラー/ページエラー/リクエスト失敗の内訳を結果JSONの各ページ要素で確認。
  - `consoleErrors`, `pageErrors`, `requestFailures`, `status` を参照。

4) REST API 403 の有無を個別確認
- 例: `curl -s -i http://localhost:8090/wp-json/`
- 例: `curl -s -i http://localhost:8090/wp-json/wp/v2/posts`
  - 403が出る場合、管理ログイン/Nonce送付が必要なエンドポイントへのアクセスが混ざっていないかを確認。
  - Cookie+Nonceの要件（WordPress公式）に合致しているかを確認（参考URLは末尾）。

5) CSPヘッダーの確認（重複/方針差異）
- 例: `curl -s -I http://localhost:8090/ | grep -i "content-security-policy"`
- サーバ（`apache-config.conf`）とテーマ（`inc/security.php` ほか）で複数のCSPが送られていないか、`connect-src` などが想定外に厳しくないかを確認。

6) X-Frame-Options 等、他セキュリティヘッダーの確認
- 例: `curl -s -I http://localhost:8090/ | egrep -i "x-frame-options|x-content-type-options|x-xss-protection"`
- 管理/プレビュー/iframe使用箇所に影響が出ていないかを切り分け。

## 対処方針（修正案の選択肢：実装は未実施）
A. テスト仕様側の調整（推奨: まずは誤検知の緩和）
- Docker `[error]` の扱いを厳格→準厳格へ変更（例）:
  - 無視できる既知のメッセージを除外（`client denied by server configuration` など特定パターンをホワイトリスト化）。
  - 現在のページ遷移と相関しない[error]は失敗カウントに含めない（時刻/リクエストパスで相関判定）。
  - E2E_TEST_MODE（`inc/e2e-test-mode.php`）を活用し、テスト時のみログを抑制/不要な拒否を回避。
- 管理系/テーマ物理パスなど「クロール不要」経路をクローラ対象から除外（内部リンク抽出のフィルタ強化）。

B. アプリ側の調整（必要に応じて最小限）
- `.htaccess` 直アクセス拒否でのログノイズ削減:
  - テスト環境では拒否時ログレベルを下げる/不要リクエストを発生させない（リンク/参照先の是正）。
- REST API 403 の抑止（テスト時のみ）:
  - テストで管理系エンドポイントに触れないようにする、もしくはE2E_TEST_MODEで読み取り専用アクセスバイパスを有効化。
- CSP の単一化/方針整合:
  - サーバとテーマのCSP送出を二重にしない（どちらかに寄せる）。
  - `connect-src`等に必要なドメイン（Google Analytics/CDN/必要なAPI）を網羅。

C. 一時回避（緊急時）
- テスト基準のみ緩和: E2Eで `dockerErrorCount` を合否判定から外す、または警告扱いに降格（恒久対応を前提に一時措置）。

## 参考（公式/一次情報）
- WordPress REST API 認証（Cookie/Nonce）
  - https://developer.wordpress.org/rest-api/using-the-rest-api/authentication/#authentication-cookies-and-nonces
- WordPress Templates エンドポイント
  - https://developer.wordpress.org/rest-api/reference/templates/
- Content-Security-Policy（MDN）
  - https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy
- X-Frame-Options（MDN）
  - https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options

## 付録：関連ファイル一覧
- E2E: `themes/kei-portfolio/tests/e2e/crawl-and-check.js`
- サーバ設定: `apache-config.conf`
- テーマCSP/セキュリティ: `themes/kei-portfolio/inc/security.php`, `themes/kei-portfolio/inc/class-security-helper.php`
- REST権限/Nonce: `themes/kei-portfolio/inc/rest-api-permissions.php`, `themes/kei-portfolio/inc/secure-nonce-handler.php`
- テーマ .htaccess: `themes/kei-portfolio/.htaccess`, `themes/kei-portfolio/assets/.htaccess`

---
本ドキュメントは原因特定と検証・対処の指針をまとめたものです。実装変更は行っていません。
