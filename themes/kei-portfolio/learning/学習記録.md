# テスト実行エラーの記録

## 発生日: 2025-08-07
## 環境: macOS / PHP 8.4.8

### エラー詳細
- データベース接続エラー
- PHPUnitがインストールされていない
- WordPressの設定ファイルが見つからない

### 対応方針
1. データベース接続設定の確認
2. PHPUnitのインストール
3. wp-config.phpの場所特定
4. テスト環境の再設定

### 技術的教訓
- テスト実行には事前に環境設定が重要
- データベース接続は最も一般的な初期設定エラー
- 開発環境とテスト環境の一貫性を保つ必要がある

---

# テスト環境セットアップスクリプト作成

## 実装日: 2025-08-07

### 作成したファイル
1. `setup-test-env.sh` - テスト環境自動セットアップスクリプト
2. `README-TESTING.md` - テスト実行手順書

### 実装のポイント

#### セットアップスクリプトの設計
- **柔軟性**: Docker環境とローカル環境の両方に対応
- **段階的実行**: Composer、npm、WordPress Test Suiteを個別にスキップ可能
- **エラーハンドリング**: 各ステップでの詳細なエラーチェック
- **ユーザビリティ**: カラー出力とわかりやすいログメッセージ

#### WordPressテスト環境の複雑性
- WordPress Test Suite は環境によって設定が大きく異なる
- データベース接続設定がDocker環境とローカル環境で異なる
- 段階的テスト実行（構文チェック→統合テスト）の重要性

#### ベストプラクティス
```bash
# 独立実行可能なテスト設計
composer test:syntax  # WordPress環境不要
composer test:all     # WordPress環境必要

# 環境検出の自動化
if [[ "$DOCKER_MODE" == "true" ]]; then
    export WP_TESTS_DB_HOST="db-test"
else
    export WP_TESTS_DB_HOST="localhost"
fi
```

### 学習した技術要素
1. **Bashスクリプト設計**: 引数解析、エラーハンドリング、カラー出力
2. **WordPress テスト設定**: PHPUnit設定、Bootstrap設定、環境変数管理
3. **Docker統合**: Docker環境でのテスト実行の考慮事項
4. **ドキュメント設計**: 技術者向けREADMEの構造化

### 技術的負債と改善点
- WordPress Test Suite のインストール自動化は未実装（手動実行が必要）
- CI/CD環境でのテスト実行時間最適化が必要
- テストデータの初期化・クリーンアップ処理の改善余地あり

### 今後の活用
- 他のWordPressプロジェクトでのテンプレートとして利用可能
- CI/CDパイプライン設計時の参考資料
- WordPress開発のテストベストプラクティス例

---

# WordPressのCSPと.htaccessによるアクセス制御問題

## 発生日: 2025-08-09
## 環境: WordPress本番環境

### 問題詳細
1. **CSP (Content Security Policy) 違反**
   - Tailwind CSS CDN (`https://cdn.tailwindcss.com`) がブロック
   - Remixicon (`https://cdn.jsdelivr.net`) がブロック
   - 結果：CSSが全く適用されない

2. **403 Forbiddenエラー**
   - `blog.js` などのJavaScriptファイルへのアクセスが拒否
   - 原因：テーマディレクトリの`.htaccess`が過度に制限的

### 根本原因
1. **CSPポリシーの設定ミス**
   - `/inc/security.php`でCSPヘッダーを送信
   - 外部CDNリソースが許可リストに含まれていなかった
   - `'unsafe-eval'`が未設定（Tailwind CDNの動作に必要）

2. **.htaccessの設定ミス**
   - `deny from all` が最初に記述され、全アクセスをブロック
   - アセットファイルへのアクセスも拒否される状態

### 解決方法
1. **CSPポリシーの適切な設定**
```php
$csp_policy = [
    "script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com",
    "style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com",
    "font-src 'self' data: https://cdn.jsdelivr.net",
    // ...
];
```

2. **.htaccessの条件付きアクセス制御**
```apache
# PHPファイルは制限、アセットは許可
<FilesMatch "\.(css|js|jpg|jpeg|png|gif|svg|webp|woff|woff2|ttf|eot|ico)$">
    Order Allow,Deny
    Allow from all
</FilesMatch>
```

### 技術的教訓
1. **CSP設計の原則**
   - 開発環境と本番環境でCSPポリシーを分ける重要性
   - CDN利用時は明示的に許可リストに追加が必要
   - `'unsafe-eval'`は必要最小限に留める（セキュリティリスク）

2. **.htaccessの階層的制御**
   - WordPressテーマディレクトリでの過度な制限は避ける
   - ファイルタイプごとの細かな制御が効果的
   - セキュリティと機能性のバランスが重要

3. **デバッグ手法**
   - ブラウザのコンソールエラーから原因を特定
   - CSP違反は具体的なディレクティブを示す
   - 403エラーは.htaccessから調査開始

### ベストプラクティス
1. **本番環境でのCDN回避**
   - Tailwind CSS CDNは開発専用
   - 本番環境ではビルド済みCSSを使用
   - パフォーマンスとセキュリティの両立

2. **セキュリティヘッダーの実装**
```php
// PHPで実装（より確実）
header("Content-Security-Policy: ...");
header("X-Frame-Options: SAMEORIGIN");
header("X-Content-Type-Options: nosniff");
```

3. **段階的なアクセス制御**
```apache
# 1. まず全体のルール
# 2. 次に特定ファイルの例外
# 3. 最後に個別の許可/拒否
```

### 技術的負債
- Tailwind CSS CDNへの依存（本番環境）
- CSPレポート機能の未実装
- アセットのバージョニング管理の不足

### 今後の改善提案
1. **ビルドプロセスの導入**
   - webpack/Viteによるアセット管理
   - PostCSSでTailwindをビルド
   - ファイルハッシュによるキャッシュ制御

2. **CSPの段階的強化**
   - Report-Onlyモードでの検証
   - CSP違反レポートの収集・分析
   - ノンス（nonce）ベースのインライン制御

3. **監視・アラート**
   - 403エラーの自動検知
   - CSP違反の通知設定
   - パフォーマンスメトリクスの追跡
