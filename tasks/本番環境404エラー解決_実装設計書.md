# 本番環境404エラー解決 実装設計書

## 1. 問題の概要

### 現象
- 本番環境で[about][skills][contact]ページが404エラーになる
- ローカル環境では正常に表示される
- テーマファイルは正しくアップロードされている

### 環境情報
- export-wordpress-site.shでthemes/kei-portfolioからthemes/kei-portfolio-uploadにコピー
- themes/kei-portfolio-uploadを本番環境にアップロード
- WordPressコアは本番環境にインストール済み

## 2. 原因分析結果

### 根本原因
**固定ページがデータベースに存在しない**

テーマファイルのアップロードだけでは、WordPressのデータベース（wp_postsテーブル）にページレコードが作成されない。

### 詳細な原因
1. **after_switch_themeフックの未発火**
   - このフックは管理画面からテーマを切り替えた時のみ発火
   - FTP/ファイルアップロードでは発火しない
   - page-creator.phpの自動ページ作成機能が実行されていない

2. **パーマリンク設定の未更新**
   - 新しいページ構造に対応したリライトルールが生成されていない
   - .htaccessファイルが更新されていない可能性

3. **キャッシュの影響**
   - サーバーサイドキャッシュ（Varnish等）
   - CDNキャッシュ
   - WordPressの内部キャッシュ

## 3. 解決策の設計

### 3.1 即座に実行可能な解決策

#### 方法A: 管理画面から手動でページを作成
**手順:**
1. WordPress管理画面にログイン
2. 「固定ページ」→「新規追加」
3. 以下の4ページを作成:
   - タイトル: About / スラッグ: about / テンプレート: page-about.php
   - タイトル: Skills / スラッグ: skills / テンプレート: page-skills.php
   - タイトル: Contact / スラッグ: contact / テンプレート: page-contact.php
   - タイトル: Portfolio / スラッグ: portfolio / テンプレート: page-portfolio.php
4. 「設定」→「パーマリンク」→「変更を保存」（設定を変更せずに保存ボタンをクリック）

#### 方法B: create-pages-cli.phpスクリプトの実行
**手順:**
1. SSHで本番サーバーにアクセス
2. WordPressのルートディレクトリに移動
3. 以下のコマンドを実行:
```bash
php wp-content/themes/kei-portfolio-upload/create-pages-cli.php
```
4. パーマリンクをリフレッシュ

### 3.2 恒久的な解決策の実装

#### 実装1: 初回アクセス時の自動ページ作成機能

**ファイル:** `inc/page-creator.php`に以下の機能を追加

```php
/**
 * 初回アクセス時にページを自動作成
 */
add_action('init', 'kei_portfolio_ensure_pages_exist');

function kei_portfolio_ensure_pages_exist() {
    // 管理画面以外かつ初回チェック時のみ実行
    if (is_admin()) {
        return;
    }
    
    // 24時間に1回のみチェック（パフォーマンス対策）
    $last_check = get_transient('kei_portfolio_pages_check');
    if ($last_check !== false) {
        return;
    }
    
    // ページの存在確認
    $page_configurations = kei_portfolio_get_page_configurations();
    $pages_missing = false;
    
    foreach ($page_configurations as $key => $config) {
        $existing_page = get_page_by_path($config['slug']);
        if (!$existing_page) {
            $pages_missing = true;
            break;
        }
    }
    
    // ページが不足している場合は作成
    if ($pages_missing) {
        kei_portfolio_create_all_pages();
        // パーマリンクをフラッシュ
        flush_rewrite_rules();
    }
    
    // 次回チェックまでの間隔を設定
    set_transient('kei_portfolio_pages_check', true, DAY_IN_SECONDS);
}
```

#### 実装2: 管理画面にページ作成ボタンを追加

**ファイル:** `inc/admin-tools.php`（新規作成）

```php
<?php
/**
 * 管理画面ツール
 */

/**
 * 管理画面メニューに追加
 */
add_action('admin_menu', 'kei_portfolio_add_admin_menu');

function kei_portfolio_add_admin_menu() {
    add_theme_page(
        'ポートフォリオ設定',
        'ポートフォリオ設定',
        'manage_options',
        'kei-portfolio-settings',
        'kei_portfolio_settings_page'
    );
}

/**
 * 設定ページの表示
 */
function kei_portfolio_settings_page() {
    ?>
    <div class="wrap">
        <h1>ポートフォリオテーマ設定</h1>
        
        <?php if (isset($_GET['pages_created'])): ?>
            <div class="notice notice-success">
                <p>固定ページが正常に作成されました。</p>
            </div>
        <?php endif; ?>
        
        <div class="card">
            <h2>固定ページ管理</h2>
            <p>テーマに必要な固定ページを作成します。</p>
            <form method="post" action="">
                <?php wp_nonce_field('kei_portfolio_create_pages', 'kei_portfolio_nonce'); ?>
                <input type="hidden" name="action" value="create_pages">
                <button type="submit" class="button button-primary">
                    固定ページを作成
                </button>
            </form>
        </div>
        
        <div class="card" style="margin-top: 20px;">
            <h2>パーマリンク設定</h2>
            <p>404エラーが発生する場合は、パーマリンクをリフレッシュしてください。</p>
            <a href="<?php echo admin_url('options-permalink.php'); ?>" class="button">
                パーマリンク設定へ
            </a>
        </div>
    </div>
    <?php
}

/**
 * ページ作成処理
 */
add_action('admin_init', 'kei_portfolio_handle_page_creation');

function kei_portfolio_handle_page_creation() {
    if (!isset($_POST['action']) || $_POST['action'] !== 'create_pages') {
        return;
    }
    
    if (!check_admin_referer('kei_portfolio_create_pages', 'kei_portfolio_nonce')) {
        return;
    }
    
    if (!current_user_can('manage_options')) {
        return;
    }
    
    // ページ作成実行
    kei_portfolio_manual_create_pages();
    
    // パーマリンクをフラッシュ
    flush_rewrite_rules();
    
    // リダイレクト
    wp_redirect(add_query_arg('pages_created', '1', $_SERVER['REQUEST_URI']));
    exit;
}
```

#### 実装3: .htaccessファイルの確認と更新

**本番環境での作業:**
1. WordPressルートディレクトリの.htaccessファイルを確認
2. 必要に応じて.htaccess-for-rootの内容をコピー
3. ファイルのパーミッションを644に設定

### 3.3 デプロイ手順の改善

#### export-wordpress-site.shの改良

```bash
#!/bin/bash

# ... 既存のコード ...

# ページ作成スクリプトの実行を促すメッセージを追加
echo "=================="
echo "重要: 本番環境へのデプロイ後の作業"
echo "=================="
echo "1. テーマファイルをアップロード"
echo "2. WordPress管理画面にログイン"
echo "3. 外観 > テーマ から「Kei Portfolio」を有効化"
echo "4. 設定 > パーマリンク で「変更を保存」をクリック"
echo "5. 外観 > ポートフォリオ設定 で「固定ページを作成」をクリック"
echo ""
echo "または、SSHアクセスが可能な場合:"
echo "php wp-content/themes/kei-portfolio-upload/create-pages-cli.php"
```

## 4. テスト計画

### 4.1 機能テスト
1. 管理画面からのページ作成機能のテスト
2. CLIスクリプトによるページ作成のテスト
3. 自動ページ作成機能のテスト

### 4.2 確認項目
- [ ] 各ページ（about, skills, contact, portfolio）が正しく表示される
- [ ] ナビゲーションメニューにページが追加される
- [ ] パーマリンクが正しく動作する
- [ ] 404エラーが解消される

### 4.3 本番環境での検証
1. キャッシュクリア後の動作確認
2. 異なるブラウザでの表示確認
3. モバイルデバイスでの動作確認

## 5. 実装優先順位

1. **緊急対応**（即実施）
   - 方法A: 管理画面から手動でページ作成
   - パーマリンクのリフレッシュ

2. **短期対応**（1週間以内）
   - 実装2: 管理画面にページ作成ボタンを追加
   - デプロイ手順書の更新

3. **中期対応**（1ヶ月以内）
   - 実装1: 初回アクセス時の自動ページ作成機能
   - 自動テストの整備

## 6. リスクと対策

### リスク1: データベース権限不足
**対策:** 事前に本番環境のWordPressユーザー権限を確認

### リスク2: キャッシュによる変更の未反映
**対策:** 
- サーバーサイドキャッシュのクリア手順を準備
- CDNキャッシュのパージ方法を確認

### リスク3: 既存コンテンツとの競合
**対策:** ページ作成前に既存ページの確認処理を実装

## 7. ドキュメント更新

### 更新が必要なドキュメント
1. デプロイ手順書
2. テーマインストールガイド
3. トラブルシューティングガイド

## 8. まとめ

本番環境での404エラーは、固定ページがデータベースに存在しないことが原因。即座の解決には手動でのページ作成とパーマリンクのリフレッシュが有効。恒久的な解決には、自動ページ作成機能の実装と管理画面ツールの追加を推奨。