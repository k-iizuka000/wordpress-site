# ワードプレス公開エラー 503 / JSON レスポンス不正エラー 切り分けチェックリスト

対象症状:
- コンソール: `POST /wp-json/wp/v2/posts/{id}/autosaves 503 (Service Unavailable)`
- 画面: 「公開に失敗しました。返答が正しい JSON レスポンスではありません。」

重要ポイント:
- 503 は「サーバ側で一時的に処理不可」(WAF/CDN、Web サーバ、PHP-FPM/プラグイン/テーマ、リソース枯渇など) が主因になりやすい。
- エディタは autosaves への `POST` に依存。エラー応答（HTML/非JSONや 5xx）だと上記メッセージが表示される。

---

## 1) クライアント側・簡易確認
- [ ] 管理画面ログイン状態で、ブラウザの開発者ツール Network を開き、失敗リクエストを選択
  - [ ] ステータスコード: 503 を確認
  - [ ] Response Body: HTML/WAFページ/メンテナンス応答になっていないか
  - [ ] Response Headers: CDN/WAF ヘッダ（例: `cf-ray`, `x-mod-security`, `server` など）
  - [ ] Request Headers: `X-WP-Nonce` が送信されているか
- [ ] 同時に下記 GET で REST 稼働確認
  - [ ] `GET /wp-json/` が JSON を返す
  - [ ] `GET /wp-json/wp/v2/posts/{id}` が 200 を返す

## 2) cURL 検証（可能なら）
管理画面から取得した Cookie と `X-WP-Nonce` を使って再現。

例: autosaves への POST（値は環境に合わせて置換）
```
curl -i \
  -X POST "https://<your-domain>/wp-json/wp/v2/posts/<POST_ID>/autosaves?_locale=user" \
  -H "X-WP-Nonce: <YOUR_NONCE>" \
  -H "Content-Type: application/json" \
  -H "Cookie: <YOUR_ADMIN_COOKIES>" \
  --data '{"title":"テスト","content":""}'
```
- [ ] ステータスが 2xx か / 5xx か
- [ ] Body が JSON か（WAF/HTML でないか）

補足: ユーザーが確認した `[{"id":20,...}]` は「配列」で、autosaves が返す典型応答（リビジョンのオブジェクト）とは形式が異なる可能性あり。503 の場合、実体は HTML エラーページのことも多い。

## 3) サーバ・アプリログ確認
- [ ] PHP エラーログ（直近のタイムスタンプで fatal/memory/timeouts）
- [ ] Web サーバ（Apache/Nginx）エラーログ（503/上流タイムアウト/upstream sent too big header など）
- [ ] WAF/ModSecurity ログ（Rule ID、ブロック理由）
- [ ] WP デバッグログ（`wp-config.php` に `define('WP_DEBUG_LOG', true);` を設定し `wp-content/debug.log` を確認）

## 4) 代表的原因の切り分け（順に一時的に無効化/回避）
- [ ] CDN/WAF を一時的にバイパス（開発モード、IP許可、`/wp-json/*` のセキュリティ緩和）
- [ ] サーバ側 WAF（ModSecurity）で該当ルールの検証・一時除外（`/wp-json/wp/v2/posts/*/autosaves`）
- [ ] すべてのプラグインを一時停止 → 再テスト → 1つずつ有効化
- [ ] テーマを一時的に標準テーマ（Twenty Twenty-Three など）に切替
- [ ] パーマリンク再保存（`.htaccess` 再生成）
- [ ] PHP リソース閾値の一時引き上げ（`memory_limit`, `max_execution_time`）

## 5) 恒久対応の候補
- [ ] WAF/CDN で `/wp-json/*` をキャッシュしない・厳格検査から除外
- [ ] ModSecurity の特定ルール ID を `/wp-json/wp/v2/posts/*/autosaves` に限って無効化
- [ ] セキュリティ系プラグイン設定で REST API をブロックしない設定に修正
- [ ] `.htaccess`/Nginx のリライトルールを標準化（REST への到達を保証）
- [ ] PHP-FPM のプロセス・タイムアウト調整、メモリ増加

## 6) 追加で確認してほしい情報（ヒアリング）
- [ ] ホスティング/構成（Apache/Nginx、PHP バージョン、PHP-FPM 有無）
- [ ] CDN/WAF（Cloudflare/Defender/ModSecurity など）使用有無
- [ ] セキュリティ系プラグイン（Wordfence, AIOWPS, iThemes 等）
- [ ] 直近で導入/更新したプラグイン or テーマ
- [ ] サイトヘルス（ツール > サイトヘルス）の「致命的な問題」
- [ ] `GET /wp-json/` と `GET /wp-json/wp/v2/posts/{id}` の結果

---

参考メモ:
- 503 は PHP ではなく、上位のWAF/CDN/サーバが応答することが多い。まずはその層を疑う。
- レスポンスが HTML/JS 断片（メンテ画面、Captcha、WAF ブロックページ等）だと、エディタは「正しい JSON ではない」と表示する。

