# WordPress本番環境キャッシュ問題解決手順

## 問題の原因
**LiteSpeed Cache プラグイン（バージョン6.5.2）**が強力なキャッシュを行っており、データベースを更新してもキャッシュされた古いコンテンツが表示されている。

## キャッシュレイヤーの構造
1. **LiteSpeed Cache プラグイン**（最も影響大）
   - ページキャッシュ
   - オブジェクトキャッシュ
   - ブラウザキャッシュ
   - CloudFlare統合機能
2. **CloudFlare CDN**（LiteSpeed経由で制御）
3. **ブラウザキャッシュ**

## 解決手順

### ステップ1: WordPress管理画面からキャッシュをクリア

1. WordPressにログイン
   ```
   https://kei-aokiki.dev/wp-admin/
   ```

2. LiteSpeed Cacheの設定画面へ
   - 左メニュー「LiteSpeed Cache」をクリック
   - または上部の管理バーにLiteSpeedアイコンがある場合はクリック

3. キャッシュをパージ
   - 「ツールボックス」タブを選択
   - 「パージ」セクションで以下を実行：
     - 「すべてをパージ」をクリック
     - 「Critical CSSをパージ」をクリック
     - 「Unique CSSをパージ」をクリック

### ステップ2: CloudFlare統合のクリア

1. LiteSpeed Cache設定画面で：
   - 「CDN」タブを選択
   - 「CloudFlare」セクションを確認
   - CloudFlare APIが設定されている場合：
     - 「CloudFlareキャッシュをパージ」ボタンをクリック

### ステップ3: サーバー上のキャッシュファイルを直接削除

SSHまたはFTP経由で：
```bash
# LiteSpeedキャッシュディレクトリをクリア
rm -rf /path/to/wordpress/wp-content/litespeed/cache/*
rm -rf /path/to/wordpress/wp-content/litespeed/cssjs/*
rm -rf /path/to/wordpress/wp-content/litespeed/ucss/*

# その他のキャッシュディレクトリも確認
rm -rf /path/to/wordpress/wp-content/cache/*
```

### ステップ4: データベースのトランジェントを削除

phpMyAdminまたはWP-CLIで：
```sql
-- オプションテーブルのトランジェントを削除
DELETE FROM wp_options WHERE option_name LIKE '%_transient_%';
DELETE FROM wp_options WHERE option_name LIKE '%_site_transient_%';

-- LiteSpeed固有のオプションを確認
SELECT * FROM wp_options WHERE option_name LIKE '%litespeed%';
```

### ステップ5: プラグインの一時無効化（最終手段）

もし上記で解決しない場合：

1. FTP/SSHでプラグインフォルダをリネーム
   ```bash
   mv plugins/litespeed-cache plugins/litespeed-cache_disabled
   ```

2. サイトを確認

3. 正しく表示されたら、プラグインを再有効化し設定を見直す

## シークレットモードと通常モードの差異への対処

### 原因
LiteSpeed Cacheの「ゲストモード最適化」または「ログインユーザー用キャッシュ」設定が原因

### 解決方法
1. LiteSpeed Cache設定で：
   - 「キャッシュ」→「キャッシュ」タブ
   - 「ゲストモードを有効にする」のチェックを外す
   - 「ログインユーザーをキャッシュする」のチェックを外す

2. 保存後、すべてのキャッシュをパージ

## 今後の予防策

### 1. 開発時の設定
```php
// wp-config.phpに追加（開発環境）
define('WP_CACHE', false);
define('LITESPEED_DISABLE_ALL', true);
```

### 2. デプロイ時のチェックリスト
- [ ] データベースの更新
- [ ] LiteSpeed Cacheをパージ
- [ ] CloudFlareキャッシュをパージ
- [ ] ブラウザのハードリロード
- [ ] シークレットモードでも確認

### 3. キャッシュ除外設定
LiteSpeed Cache設定で重要なページを除外：
- 管理画面：`/wp-admin/*`
- APIエンドポイント：`/wp-json/*`
- 動的コンテンツページ

## 緊急時の対処

### すぐにキャッシュを無効化する方法

1. .htaccessに追加：
```apache
<IfModule LiteSpeed>
  CacheDisable public /
</IfModule>
```

2. またはwp-config.phpに追加：
```php
define('LITESPEED_ON', false);
```

## 確認コマンド

```bash
# キャッシュヘッダーを確認
curl -I https://kei-aokiki.dev

# X-LiteSpeed-Cache ヘッダーを探す
# hit = キャッシュから配信
# miss = 新規生成
```

## 注意事項
- キャッシュクリア後、サイトが一時的に遅くなる可能性がある
- 必ずバックアップを取ってから作業する
- 本番環境での作業は低トラフィック時間帯に行う