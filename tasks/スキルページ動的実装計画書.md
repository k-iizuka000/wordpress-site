# スキルページ動的実装計画書

## 概要
WordPressのスキル表示ページ（page-skills.php）を、ハードコードされたデータからportfolio.jsonの動的データ取得に変更する実装計画。

## 現状分析

### 現在の実装
- `/themes/kei-portfolio/page-skills.php`でスキル情報がハードコードされている
- `skill_mapping`配列に言語名、レベル、アイコン、色が固定値として定義されている
- Portfolio_Dataクラスからスキルデータは取得しているが、詳細情報はハードコード

### 利用可能なデータ
- `/themes/kei-portfolio/data/portfolio.json`
  - `projects`配列: 過去のプロジェクト情報
  - `inProgress`配列: 進行中のプロジェクト情報
  - 各プロジェクトの`topSkills`: 使用した主要スキル
  - 各プロジェクトの`period`: 開始・終了日

## 実装要件

### 必須要件
1. portfolio.jsonから動的にスキル情報を取得
2. 各スキルについて以下を計算・表示：
   - スキル名（topSkillsから取得）
   - 使用期間（最初の使用から最後の使用までの年数）
   - 使用回数（プロジェクト数）
   - 表示形式: [Java, 3年, 5回]

### 設計要件
- 既存のPortfolio_Dataクラスとの整合性を保つ
- アイコンと色のマッピングは現状維持（UIの一貫性のため）
- レベル（パーセンテージ）は自動計算

## 実装設計

### 1. Portfolio_Dataクラスの拡張

#### 新規メソッド: `get_skills_statistics()`

```php
/**
 * スキルごとの統計情報を取得
 * @return array スキル統計情報の配列
 */
public function get_skills_statistics() {
    $projects = $this->get_projects();
    $in_progress = $this->get_in_progress_projects();
    $all_projects = array_merge($projects, $in_progress);
    
    $skill_stats = [];
    
    foreach ($all_projects as $project) {
        if (isset($project['topSkills']) && is_array($project['topSkills'])) {
            foreach ($project['topSkills'] as $skill) {
                $normalized_skill = $this->normalize_skill_name($skill);
                
                if (!isset($skill_stats[$normalized_skill])) {
                    $skill_stats[$normalized_skill] = [
                        'name' => $skill,
                        'display_name' => $this->get_display_name($skill),
                        'projects' => [],
                        'first_used' => null,
                        'last_used' => null,
                        'usage_count' => 0
                    ];
                }
                
                // プロジェクト情報を追加
                $skill_stats[$normalized_skill]['projects'][] = [
                    'title' => $project['title'],
                    'start' => $project['period']['start'],
                    'end' => $project['period']['end']
                ];
                
                // 使用期間を更新
                $start_date = strtotime($project['period']['start']);
                $end_date = strtotime($project['period']['end']);
                
                if (!$skill_stats[$normalized_skill]['first_used'] || 
                    $start_date < $skill_stats[$normalized_skill]['first_used']) {
                    $skill_stats[$normalized_skill]['first_used'] = $start_date;
                }
                
                if (!$skill_stats[$normalized_skill]['last_used'] || 
                    $end_date > $skill_stats[$normalized_skill]['last_used']) {
                    $skill_stats[$normalized_skill]['last_used'] = $end_date;
                }
                
                $skill_stats[$normalized_skill]['usage_count']++;
            }
        }
    }
    
    // 各スキルの期間と熟練度を計算
    foreach ($skill_stats as &$skill) {
        $skill['duration_years'] = $this->calculate_duration_years(
            $skill['first_used'], 
            $skill['last_used']
        );
        $skill['level'] = $this->calculate_skill_level($skill);
        $skill['category'] = $this->determine_skill_category($skill['name']);
    }
    
    return $skill_stats;
}
```

#### サポートメソッド

```php
/**
 * スキル名を正規化（括弧内の情報を除去）
 */
private function normalize_skill_name($skill) {
    // "Java(Spring)" -> "Java"
    return preg_replace('/\([^)]+\)/', '', $skill);
}

/**
 * 表示用のスキル名を取得
 */
private function get_display_name($skill) {
    // "Java(Spring)" -> "Java/Spring"
    return str_replace(['(', ')'], ['/', ''], $skill);
}

/**
 * 使用期間（年数）を計算
 */
private function calculate_duration_years($first_used, $last_used) {
    if (!$first_used || !$last_used) return 0;
    
    $years = ($last_used - $first_used) / (365 * 24 * 60 * 60);
    return max(1, round($years)); // 最低1年
}

/**
 * スキルレベルを自動計算（0-100）
 */
private function calculate_skill_level($skill_data) {
    $level = 50; // ベースレベル
    
    // 使用期間による評価（最大40点）
    $years = $skill_data['duration_years'];
    $duration_score = min(40, $years * 10);
    
    // 使用頻度による評価（最大30点）
    $usage = $skill_data['usage_count'];
    $frequency_score = min(30, $usage * 5);
    
    // 最近性による評価（最大30点）
    $recency_score = 0;
    if ($skill_data['last_used']) {
        $months_ago = (time() - $skill_data['last_used']) / (30 * 24 * 60 * 60);
        if ($months_ago < 6) $recency_score = 30;
        elseif ($months_ago < 12) $recency_score = 20;
        elseif ($months_ago < 24) $recency_score = 10;
    }
    
    $level = $duration_score + $frequency_score + $recency_score;
    
    return min(100, max(50, $level));
}

/**
 * スキルのカテゴリを判定
 */
private function determine_skill_category($skill_name) {
    $frontend_keywords = ['JavaScript', 'Vue', 'React', 'HTML', 'CSS', 'JSP', 'Calendar'];
    $backend_keywords = ['Java', 'Spring', 'Python', 'SQL', 'Node', 'COBOL', 'Ruby', 'PHP'];
    
    $normalized = $this->normalize_skill_name($skill_name);
    
    foreach ($frontend_keywords as $keyword) {
        if (stripos($normalized, $keyword) !== false) {
            return 'frontend';
        }
    }
    
    foreach ($backend_keywords as $keyword) {
        if (stripos($normalized, $keyword) !== false) {
            return 'backend';
        }
    }
    
    return 'other';
}
```

### 2. page-skills.phpの改修

#### 主な変更点

1. **スキル統計データの取得**
```php
$skill_statistics = $portfolio_data->get_skills_statistics();
```

2. **既存のマッピング配列を保持（UIのため）**
```php
// アイコンと色のマッピング（UI要素のため保持）
$ui_mapping = [
    'JavaScript' => ['icon' => 'ri-javascript-line', 'color' => 'bg-yellow-500'],
    'Vue' => ['icon' => 'ri-vuejs-line', 'color' => 'bg-green-500'],
    // ... 他のマッピング
];
```

3. **表示部分の改修**
```php
foreach ($skill_statistics as $skill_key => $skill_data) {
    if ($skill_data['category'] !== 'frontend') continue;
    
    $ui_data = isset($ui_mapping[$skill_key]) ? 
        $ui_mapping[$skill_key] : 
        ['icon' => 'ri-code-line', 'color' => 'bg-gray-500'];
    ?>
    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 text-center">
        <div class="flex items-center justify-center w-12 h-12 <?php echo esc_attr($ui_data['color']); ?> rounded-lg mx-auto mb-3">
            <i class="<?php echo esc_attr($ui_data['icon']); ?> text-white text-xl"></i>
        </div>
        <h3 class="font-semibold text-gray-800 mb-2">
            <?php echo esc_html($skill_data['display_name']); ?>
        </h3>
        <div class="text-xs text-gray-600 mb-2">
            <span><?php echo esc_html($skill_data['duration_years']); ?>年</span>
            <span class="mx-1">・</span>
            <span><?php echo esc_html($skill_data['usage_count']); ?>案件</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="<?php echo esc_attr($ui_data['color']); ?> h-2 rounded-full transition-all duration-1000 ease-out" 
                 style="width: <?php echo esc_attr($skill_data['level']); ?>%"></div>
        </div>
        <span class="text-xs text-gray-600 mt-1 block"><?php echo esc_html($skill_data['level']); ?>%</span>
    </div>
    <?php
}
```

## テスト戦略

### 1. 単体テスト（PHPUnit）

```php
class Test_Portfolio_Data_Skills extends WP_UnitTestCase {
    
    public function test_get_skills_statistics() {
        // スキル統計が正しく集計されることを確認
    }
    
    public function test_normalize_skill_name() {
        // "Java(Spring)" -> "Java" の変換を確認
    }
    
    public function test_calculate_skill_level() {
        // レベル計算の正確性を確認
    }
    
    public function test_determine_skill_category() {
        // カテゴリ判定の正確性を確認
    }
}
```

### 2. 統合テスト

- JSONファイルからデータ取得
- スキル統計の計算
- ページでの表示

### 3. エッジケーステスト

- 空のtopSkills配列
- 無効な日付形式
- 重複スキル名の扱い
- "Java"と"Java(Spring)"の区別

## パフォーマンス最適化

### キャッシュ戦略
```php
public function get_skills_statistics() {
    $cache_key = 'portfolio_skills_statistics';
    $cached = get_transient($cache_key);
    
    if ($cached !== false) {
        return $cached;
    }
    
    // 統計を計算
    $statistics = $this->calculate_statistics();
    
    // 1時間キャッシュ
    set_transient($cache_key, $statistics, HOUR_IN_SECONDS);
    
    return $statistics;
}
```

## エラーハンドリング

1. **JSONファイル読み込みエラー**
   - フォールバック: 既存のハードコードデータを使用

2. **データ不整合**
   - 必須フィールドの欠落チェック
   - デフォルト値の設定

3. **計算エラー**
   - ゼロ除算の防止
   - 無効な日付のハンドリング

## 実装スケジュール

| フェーズ | タスク | 所要時間 |
|---------|--------|----------|
| Phase 1 | Portfolio_Dataクラスの拡張 | 4時間 |
| Phase 2 | page-skills.phpの改修 | 2時間 |
| Phase 3 | テストコードの実装 | 3時間 |
| Phase 4 | 動作確認と調整 | 1時間 |

## 期待される成果

1. **メンテナンス性向上**
   - portfolio.jsonの更新のみでスキル情報が自動更新

2. **正確性向上**
   - 実際のプロジェクトデータに基づいた統計

3. **拡張性**
   - 将来的な管理画面での編集機能追加が容易

## リスクと対策

| リスク | 対策 |
|--------|------|
| 既存表示の大幅な変更 | UIマッピングは保持し、段階的に移行 |
| パフォーマンス低下 | Transient APIによるキャッシュ実装 |
| データ不整合 | バリデーションとフォールバック機構 |

## 実装チェックリスト

- [ ] Portfolio_Dataクラスにget_skills_statistics()メソッドを追加
- [ ] スキル名の正規化処理を実装
- [ ] 使用期間と使用回数の計算ロジックを実装
- [ ] スキルレベルの自動計算を実装
- [ ] page-skills.phpを動的データ取得に変更
- [ ] 表示フォーマットを[スキル名, X年, Y回]に更新
- [ ] キャッシュ機能を実装
- [ ] エラーハンドリングを実装
- [ ] PHPUnitテストを作成
- [ ] 動作確認とデバッグ