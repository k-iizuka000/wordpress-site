# 管理AI→エージェント依頼プロンプト（厳格版）

目的
- `tasks/e2e通過までのエージェント連携作業フロー.md` に定義された手順・制約の通りに、各エージェントへ一貫した指示を出すためのテンプレート。
- 指示逸脱（誤コマンド実行・テスト変更等）を防ぎ、承認と証跡を必須化する。

共通ポリシー（全エージェント共通で読み上げ）
- 参照ドキュメント: `tasks/e2e通過までのエージェント連携作業フロー.md`
- 変更禁止範囲: `tests/**`、`run-tests.sh`、テーマ配下 `package.json` の `scripts.e2e`
- 変更許容範囲: WordPress実装（`themes/**` の PHP/JS/CSS 他サイト挙動に関わるコード）のみ
- 2段階承認が必要: 着手前に「予定コマンド/対象ファイル」を提示→承認後に実行
- 成功報告には証跡必須: 実行コマンド・終了コード・ログ保存先・grep確認結果
- 例外（テスト側の変更）が必要と判断した場合: 理由＋最小差分案を提示し、承認が出るまで実施禁止

---

# 1) test-executor 依頼プロンプト
以下の指示に厳密に従ってください。逸脱は禁止です。

- 実行目的: E2Eテストの実行と結果分析
- 実行コマンド（固定・必須）:
  - `BASE_URL=http://localhost:8090 ./run-tests.sh e2e`
  - 上記以外のE2E実行（例: `npm run e2e`）は禁止
- 実行前（承認待ち）で以下を提示してください:
  - 予定コマンド（上記と完全一致すること）
- 実行後に提出する証跡（必須）:
  - 実行コマンド、開始/終了時刻、終了コード
  - ログ保存先: `tests/YYYYMMDD-hhmm-e2e-run.log`
  - grep検証結果（`crawl-and-check` もしくはE2Eサマリー行の一致）
  - 標準出力の先頭/末尾50行の抜粋
- 結果報告の形式:
  - 失敗要約（テスト名/症状/スタックトレース断片/推定原因/優先度）
  - 次の一手（再実行/環境診断/実装修正のいずれか）
- 注意: grepが一致しない場合「E2E成功」と報告してはなりません

---

# 2) wordpress-fullstack-developer 依頼プロンプト
以下の指示に厳密に従ってください。逸脱は禁止です。

- 目的: E2E失敗の原因をWordPress実装側で最小修正
- 変更許容: `themes/**` の PHP/JS/CSS（サイト挙動）のみ
- 変更禁止: `tests/**`、`run-tests.sh`、テーマ配下 `package.json` の `scripts.e2e`
- 着手前（承認待ち）で以下を提示:
  - 変更候補ファイル一覧（禁止パスを含まないことを自己検証）
  - 最小修正の要点（1〜3行）
- 実装後:
  - 差分の要約（関数/フック/テンプレ/JSのポイント）
  - リスクとロールバック手段
- 注意: テスト側の修正提案が必要な場合は、理由＋最小差分案を提示し承認待ち。承認が無い限り手を付けないこと

---

# 3) code-review-post-implementation 依頼プロンプト
- 対象: 今回の差分のみ
- 最優先チェック: 禁止パスの変更有無（`tests/**`、`run-tests.sh`、`scripts.e2e`）
  - 含まれる場合は【重大】で差し戻し（管理AIの明示承認がない限り不可）
- レビュー観点: セキュリティ/品質/性能/CLAUDE.md準拠（簡潔に）
- 出力形式: 既定テンプレに準拠（総評/良い点/改善提案/セキュリティチェック）

---

# 4) security-audit-post-development 依頼プロンプト
- 目的: 修正完了後の最終セキュリティ監査
- チェックリスト（必須）:
  - [ ] フルパス（個人情報）の削除
  - [ ] APIキー・トークンの確認
  - [ ] パスワードのハードコーディング確認
  - [ ] 機密ファイルの取り扱い確認
  - [ ] 環境変数の適切な使用確認
- 出力: 監査レポート（合格/要修正、重要度別の指摘と対処案）

---

# 5) document-manager-ja 依頼プロンプト
- 目的: 失敗トリアージ/進捗ログ/学習記録の更新
- 作業:
  - 本タスクの作業ログとトリアージを `tasks/e2e通過までのエージェント連携作業フロー.md` に追記
  - 学習は `learning/学習記録.md` に追記（ノイズを避け簡潔に）

---

# 6) test-environment-docker-architect 依頼プロンプト（必要時）
- 目的: 環境/ネットワーク/ブラウザ/Puppeteer/Docker起因の失敗診断
- 着手前（承認待ち）で提示:
  - 疑われるコンポーネント（例: コンテナビルド、ヘルスチェック、ポート、ブラウザ）
  - 診断コマンド案と想定結果
- 出力: 問題点と最小修正案（差分が必要な場合は具体ファイルと行為を明示）

---

# 7) wordpress-php-test-designer 依頼プロンプト（必要時）
- 目的: 再発/フレーク/複雑度増大時のテスト設計・戦略見直し
- 前提: テスト変更は原則禁止だが、設計是正の提案は受け付ける（実施は管理AIの承認後）
- 出力: 再発防止策と設計指針、必要なら段階的な導入計画

---

# 付録: 実行前チェックリスト（エージェントが必ず回答）
- 実行コマンドは固定コマンドと完全一致する（該当時）: [はい/いいえ]
- 変更対象に禁止パス（tests/**, run-tests.sh, scripts.e2e）が含まれない: [はい/いいえ]
- 実行後の証跡（終了コード・ログ保存先・grep一致）を提示できる（該当時）: [はい/いいえ]
- テスト側変更が必要な場合は、理由と最小差分案を提示し承認まで停止する: [はい/いいえ]

---

# コピペ用（test-executor 向け最小プロンプト）
次を厳守してE2Eを実行してください。実行前に予定コマンドを提示し、承認を待ってから実行してください。
- 実行コマンド固定: BASE_URL=http://localhost:8090 ./run-tests.sh e2e（他は禁止）
- 実行後の証跡: 実行コマンド/時刻/終了コード、tests/YYYYMMDD-hhmm-e2e-run.log の保存、`crawl-and-check` かE2Eサマリー行のgrep一致、標準出力の先頭/末尾50行
- 結果報告: 失敗要約（テスト名/症状/スタック/推定原因/優先度）と次の一手
- 注意: grep未一致の場合は成功と報告しない

