# WordPress サイト移行スクリプト検証手順書

## 概要
`export-wordpress-site.sh` スクリプトの動作を検証し、本番環境への移行が正しく行われることを確認する手順書です。

## 検証環境
- ローカル開発環境（Docker）
- テスト用の別ディレクトリまたはステージング環境

## 検証手順

### 1. 事前準備の検証

#### 1.1 必要なファイルの存在確認
```bash
# portfolio.json の存在確認
ls -la /Users/kei/work/wordpress-site/themes/kei-portfolio/data/portfolio.json

# テーマディレクトリの確認
ls -la /Users/kei/work/wordpress-site/themes/kei-portfolio/
ls -la /Users/kei/work/wordpress-site/themes/kei-portfolio-upload/

# Dockerコンテナの確認
docker ps | grep kei-portfolio-db
```

#### 1.2 バックアップの作成
```bash
# 現在の状態をバックアップ
tar czf backup_before_test_$(date +%Y%m%d_%H%M%S).tar.gz \
  themes/kei-portfolio \
  themes/kei-portfolio-upload \
  database-exports
```

### 2. スクリプト実行の検証

#### 2.1 ドライラン（実際には実行しない確認）
```bash
# スクリプトの構文チェック
bash -n export-wordpress-site.sh

# 実行権限の確認
ls -la export-wordpress-site.sh
```

#### 2.2 スクリプトの実行
```bash
# スクリプトを実行
./export-wordpress-site.sh

# 実行中の出力を記録
./export-wordpress-site.sh 2>&1 | tee export_log_$(date +%Y%m%d_%H%M%S).log
```

### 3. 出力ファイルの検証

#### 3.1 生成されたファイルの確認
```bash
# エクスポートディレクトリの確認
ls -la site-exports/[最新の日付ディレクトリ]/

# 期待されるファイル:
# - kei-portfolio-theme_*.tar.gz
# - database_*.sql
# - database_*.sql.gz
# - migration-checklist.md
```

#### 3.2 portfolio.json の確認
```bash
# アーカイブ内のportfolio.json確認
cd site-exports/[最新の日付ディレクトリ]/
tar tzf kei-portfolio-theme_*.tar.gz | grep portfolio.json

# 一時ディレクトリで展開して確認
mkdir temp_check
cd temp_check
tar xzf ../kei-portfolio-theme_*.tar.gz
ls -la data/portfolio.json
cat data/portfolio.json | head -20
cd ..
rm -rf temp_check
```

#### 3.3 データベースファイルの検証
```bash
# SQLファイルのサイズ確認
ls -lh database_*.sql*

# URL置換の確認
grep -c "localhost:8090" database_*.sql
grep -c "kei-aokiki.dev" database_*.sql

# SQLファイルの基本的な構造確認
head -50 database_*.sql
```

### 4. テーマファイルの詳細検証

#### 4.1 除外ファイルの確認
```bash
# 不要なファイルが除外されているか確認
tar tzf kei-portfolio-theme_*.tar.gz | grep -E "(node_modules|vendor|tests|coverage)"

# 結果が空であることを確認（除外されていれば何も表示されない）
```

#### 4.2 必要なファイルの確認
```bash
# 必要なファイルがすべて含まれているか確認
tar tzf kei-portfolio-theme_*.tar.gz | grep -E "(functions.php|style.css|index.php|data/portfolio.json)"
```

### 5. ローカル環境での復元テスト

#### 5.1 テスト用ディレクトリの準備
```bash
# テスト用ディレクトリを作成
mkdir -p test-migration/themes
cd test-migration/themes
```

#### 5.2 アーカイブの展開
```bash
# テーマファイルを展開
tar xzf ../../site-exports/[最新の日付]/kei-portfolio-theme_*.tar.gz -C .

# ファイル構造の確認
find . -type f -name "*.php" | head -10
find . -type f -name "*.json"
```

#### 5.3 portfolio.json の内容確認
```bash
# JSONファイルの妥当性チェック
python3 -m json.tool data/portfolio.json > /dev/null && echo "JSONフォーマット: OK" || echo "JSONフォーマット: エラー"

# 重要なデータの存在確認
grep -q "about" data/portfolio.json && echo "aboutセクション: OK"
grep -q "skills" data/portfolio.json && echo "skillsセクション: OK"
grep -q "projects" data/portfolio.json && echo "projectsセクション: OK"
```

### 6. チェックリストの検証

#### 6.1 migration-checklist.md の確認
```bash
# チェックリストの内容確認
cat site-exports/[最新の日付]/migration-checklist.md

# 手順の実行可能性を確認
```

### 7. エラーケースのテスト

#### 7.1 Dockerコンテナ停止時のテスト
```bash
# コンテナを停止
docker stop kei-portfolio-db

# スクリプトを実行（エラーが適切に処理されるか確認）
./export-wordpress-site.sh

# コンテナを再起動
docker start kei-portfolio-db
```

#### 7.2 ファイル欠損時のテスト
```bash
# portfolio.jsonを一時的に移動
mv themes/kei-portfolio/data/portfolio.json themes/kei-portfolio/data/portfolio.json.bak

# スクリプトを実行（エラーが適切に処理されるか確認）
./export-wordpress-site.sh

# ファイルを戻す
mv themes/kei-portfolio/data/portfolio.json.bak themes/kei-portfolio/data/portfolio.json
```

## 検証チェックリスト

### 基本機能
- [ ] スクリプトがエラーなく実行される
- [ ] エクスポートディレクトリが正しく作成される
- [ ] 日付付きのサブディレクトリが作成される

### ファイル移行
- [ ] portfolio.json がkei-portfolio-uploadにコピーされる
- [ ] テーマアーカイブが作成される
- [ ] 不要なファイルが除外される
- [ ] 必要なファイルがすべて含まれる

### データベース
- [ ] データベースがエクスポートされる
- [ ] URLが正しく置換される（localhost:8090 → kei-aokiki.dev）
- [ ] 圧縮ファイルが作成される

### ドキュメント
- [ ] migration-checklist.md が生成される
- [ ] チェックリストの内容が適切である

### エラーハンドリング
- [ ] ファイルが存在しない場合のエラー処理
- [ ] Dockerコンテナが起動していない場合のエラー処理
- [ ] ディレクトリ作成失敗時のエラー処理

## トラブルシューティング

### portfolio.json がコピーされない
1. ソースファイルの存在確認
2. ディレクトリのパーミッション確認
3. スクリプトの該当部分のデバッグ出力追加

### アーカイブにファイルが含まれない
1. tar コマンドの除外オプション確認
2. ソースディレクトリの内容確認
3. 作業ディレクトリの確認

### データベースエクスポートが失敗
1. Dockerコンテナの状態確認
2. データベース接続情報の確認
3. mysqldump コマンドの手動実行テスト

## 本番環境での確認事項

### 移行前
- [ ] 本番環境のバックアップ完了
- [ ] メンテナンスモードの有効化
- [ ] 移行ファイルの転送完了

### 移行後
- [ ] テーマの有効化確認
- [ ] portfolio.json データの反映確認
- [ ] 全ページの表示確認
- [ ] JavaScriptエラーの確認
- [ ] フォーム動作確認

## 結果の記録

### テスト実施日時
- 実施日: ____年____月____日
- 実施者: ________________

### テスト結果
- [ ] すべての検証項目をクリア
- [ ] 問題なく本番環境への移行が可能

### 発見された問題と対処
（問題があった場合は記載）

### 改善提案
（スクリプトや手順の改善案があれば記載）