# 本番環境ログ制御実装計画（改訂）

## 目的
本番環境でブラウザコンソールの情報系ログを抑止し、PHPログは安全に集約。Docker 実行時は必要最小限のログを許容する。

## 現状分析（要点）
- JS: `themes/kei-portfolio/assets/js/` 下にログ出力あり（search.js / blog-ajax.js / utils.js / secure-blog.js / blog.js 等）。
- PHP: `themes/kei-portfolio/inc/` 下で `error_log()` や独自ロガー（`class-blog-logger.php`）が共存。
- 環境判定: `inc/environment-config.php` で `WP_ENVIRONMENT_TYPE`/`WP_DEBUG`/ホストから判定。

## 実装方針（矛盾排除・最小改修）

### 1. 環境判定の強化（environment-config.php）
- 優先順位を明記: `WP_ENVIRONMENT_TYPE` 優先（development/staging/production）。
- Docker検出を公開メソッド化し統一利用。
  ```php
  // 例: public メソッドとして追加
  public function is_docker_environment(): bool {
      if (file_exists('/.dockerenv')) return true;
      if (getenv('DOCKER_CONTAINER') === 'true') return true;
      if (getenv('COMPOSE_PROJECT_NAME')) return true;
      return false;
  }
  ```
- 本番のログ出力先を保証: 初期化時に `wp-content/logs/` を作成し、`.htaccess`/`index.php` を配置して直アクセス不可にする。

### 2. JSログ抑制は「console差し替え」を採用（置換不要）
- 本番 かつ 非Docker のときに限り、`console.log/info/warn/debug` を no-op へ差し替える軽量スニペットを `<head>` 早期で挿入。`console.error` は常に有効。
- 一時的デバッグ回避口を用意（任意）: クエリ `?debug=1` または `localStorage.setItem('keiDebug','1')` がある場合は抑止を無効化。
- これにより既存 ~26 ファイルの大規模置換（KeiLogger 導入）は不要。将来必要になれば第2段階としてラッパー移行を検討。

挿入スニペット（計画イメージ）:
```html
<script>
(function(){
  var isProd = <?php echo json_encode(kei_portfolio_is_production()); ?>;
  var isDocker = <?php echo json_encode(kei_portfolio_get_env_config()->is_docker_environment()); ?>;
  var bypass = /[?&]debug=1\b/.test(location.search) || localStorage.getItem('keiDebug')==='1';
  if (isProd && !isDocker && !bypass) {
    var noop=function(){};
    console.log = noop; console.info = noop; console.warn = noop; console.debug = noop;
  }
})();
</script>
```
設置場所: `enqueue-safe.php` で head 早期（例: `tailwindcss` の前後）にインライン追加。

### 3. PHPログは既存 Blog_Logger に一本化（アダプタ関数追加）
- 新規の独自ログ関数で分散させない。共通ユーティリティ `Blog_Logger`（`inc/class-blog-logger.php`）を“正”とし、必要なら薄いアダプタ関数を追加。
- レベル整合性: `startup` は導入しない（利用時は `info` に正規化）。
- 本番: 重要なエラーのみ。開発/Docker: デバッグ許容（`WP_DEBUG`/設定に準拠）。

アダプタ（計画イメージ）:
```php
function kei_portfolio_log($message, $level = 'info', $context = []) {
    $logger = \KeiPortfolio\Blog\Blog_Logger::get_instance();
    switch (strtolower($level)) {
        case 'debug': return $logger->debug($message, $context);
        case 'info': return $logger->info($message, $context);
        case 'warning': case 'warn': return $logger->warning($message, $context);
        case 'error': return $logger->error($message, $context);
        case 'critical': return $logger->critical($message, $context);
        default: return $logger->info($message, $context);
    }
}
```

### 4. ユーザー出力（echo/var_dump）の扱い
- デバッグ目的の `echo/var_dump/print_r` は排除。UI用途の出力は対象外。
- 既存ファイルの“デバッグ出力のみ”を点検し、`kei_portfolio_log('...', 'debug')` に置換（必要箇所のみ）。

## 実装手順（最小差分）
1. environment-config.php を拡張
   - `public function is_docker_environment()` を追加
   - 初期化時に `wp-content/logs/` 生成とアクセス制限ファイル配置
   - 本番の `display_errors=0` と `error_log` 設定の再確認
2. enqueue-safe.php にインライン JS を追加
   - 上記「console差し替え」スニペットを head 早期に挿入
   - 条件は「本番 && 非Docker && 非デバッグ」
3. PHP ログの一本化
   - 薄いアダプタ `kei_portfolio_log()` を追加（Blog_Logger へ委譲）
   - 既存の `error_log()` を段階的に必要箇所のみ置換（無理に一括しない）
4. テスト
   - 本番モードでブラウザのコンソールに `log/info/warn/debug` が出ないこと（`?debug=1` では出る）
   - 本番レスポンスに PHP 警告が混入しないこと（cURL + grep）
   - `wp-content/logs/` へ書込可・直アクセス不可を確認

## 影響範囲（改訂）
- JS: 既存ファイルの修正は原則不要（インライン抑止のみ）。
- PHP: `environment-config.php`・`enqueue-safe.php`・（必要に応じて）アダプタ関数を追加する小改修。

## 優先順位
1. 高: 本番でのJSログ抑止と PHP のエラー非表示化の保証
2. 中: ログ出力先の保護（`logs/` 作成・アクセス制限）
3. 低: 既存 `error_log()` の段階的置換（必要箇所のみ）

## 注意事項
- `console.error` は抑止しない（障害調査の最低限確保）。
- キャッシュ/HTML静的化を用いる環境では、デバッグバイパス（`?debug=1`）の動作確認を行う。
- 情報露出最小化のため、JSへ渡す環境情報は boolean（isProduction/isDocker）のみに限定（文字列の環境名は不要）。
